<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so"><link rel=alternate hreflang=en-us href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/><meta name=theme-color content="#2962ff"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono%7CFira+Code&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_2.png><link rel=canonical href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@rh0main"><meta property="twitter:creator" content="@rh0main"><meta property="og:site_name" content="Romain Thomas"><meta property="og:url" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/"><meta property="og:title" content="r2-pay: whitebox (part 2) | Romain Thomas"><meta property="og:description" content="This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so"><meta property="og:image" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png"><meta property="twitter:image" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-09-27T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-27T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/"},"headline":"r2-pay: whitebox (part 2)","image":["https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png"],"datePublished":"2020-09-27T00:00:00Z","dateModified":"2020-09-27T00:00:00Z","author":{"@type":"Person","name":"Romain Thomas"},"publisher":{"@type":"Organization","name":"Romain Thomas","logo":{"@type":"ImageObject","url":"https://www.romainthomas.fr/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_2.png"}},"description":"This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so"}</script><title>r2-pay: whitebox (part 2) | Romain Thomas</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Romain Thomas</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Romain Thomas</a></div><div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#projects-images><span>Gallery</span></a></li><li class=nav-item><a class=nav-link href=/#work-experience><span>Work experience</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>r2-pay: whitebox (part 2)</h1><div class=article-metadata><div><span>Romain Thomas</span></div><span class=article-date>Sep 27, 2020</span>
<span class=middot-divider></span><span class=article-reading-time>8 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/categories/android/>Android</a>, <a href=/categories/reverse-engineering/>Reverse Engineering</a></span></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:390px><div style=position:relative><img src=/post/20-09-r2con-obfuscated-whitebox-part2/featured_hu10c4b997cebf9fd3ba89cc6ffc564a2f_256619_720x0_resize_lanczos_2.png alt class=featured-image></div></div><div class=article-container><div class=article-style><style>.green{color:green;font-family:fira code,monospace;font-size:87.5%}.blue{color:blue;font-family:fira code,monospace;font-size:87.5%}.orange{color:tomato;font-family:fira code,monospace;font-size:87.5%}.red{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-comment{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-keyword{color:#a90d91;font-family:fira code,monospace;font-size:87.5%}.hl-literal{color:#1c01ce;font-family:fira code,monospace;font-size:87.5%}.hl-preproc{color:#633820;font-family:fira code,monospace;font-size:87.5%}.hl-strings{color:#c41a16;font-family:fira code,monospace;font-size:87.5%}.yellow{color:#cc7000;font-family:fira code,monospace;font-size:87.5%}#</style><h2 id=introduction>Introduction</h2><p>In the
<a href=/post/20-09-r2con-obfuscated-whitebox-part1/>first part</a> of this write-up, we described the
anti-frida, anti-debug and anti-root techniques used in the application and how to remove most of them.</p><p>This second part digs into the JNI function <code>gXftm3iswpkVgBNDUp</code> and the underlying whitebox implementation.</p><h2 id=library-shimming>Library Shimming</h2><p>The inputs of the function <code>gXftm3iswpkVgBNDUp</code> are provided by the GUI widgets and the function
is triggered when we press the <em>Generate R2Coin</em> button.
Nevertheless, the behavior of <code>gXftm3iswpkVgBNDUp</code> does not rely on UI features nor
the application&rsquo;s context<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>To take a closer look at the logic of <code>gXftm3iswpkVgBNDUp</code>, it would be pretty useful to be able to feed
the function&rsquo;s inputs with our <strong>own standalone binary</strong>. Basically, we would like to achieve this kind
of interface:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv) {
  <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> dlopen(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>, RTLD_NOW);
  ...
  jbyteArray out <span style=color:#f92672>=</span> gXftm3iswpkVgBNDUp(env, ...);
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>This technique is not new and has been already described in a blog post by
<a href=https://twitter.com/caleb_fenton target=_blank rel=noopener>Caleb Fenton</a><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. The idea is to get
the <code>JNIEnv* env</code> variable with <code>JNI_CreateJavaVM</code> which is exported by the Android runtime: <code>libart.so</code>.</p><p>Once we have this variable, we can call the <code>gXftm3iswpkVgBNDUp</code> function as well as manipulating the JNI buffers:</p><ul><li><code>env->NewByteArray()</code></li><li><code>env->GetArrayLength()</code></li><li>&mldr;</li></ul><p><img src=shim_mechanism.png alt="Shimming of whitebox library"></p><p>Long story short, we can instantiate the Android runtime with the following piece of code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv) {
  JavaVMOption opt[<span style=color:#ae81ff>2</span>];
  opt[<span style=color:#ae81ff>0</span>].optionString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-Djava.class.path=/data/local/tmp/re.pwnme.1.0.apk&#34;</span>;
  opt[<span style=color:#ae81ff>1</span>].optionString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-Djava.library.path=/data/local/tmp&#34;</span>;

  JavaVMInitArgs args;
  args.version            <span style=color:#f92672>=</span> JNI_VERSION_1_6;
  args.options            <span style=color:#f92672>=</span> opt;
  args.nOptions           <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
  args.ignoreUnrecognized <span style=color:#f92672>=</span> JNI_FALSE;

  <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> handler <span style=color:#f92672>=</span> dlopen(<span style=color:#e6db74>&#34;/system/lib64/libart.so&#34;</span>, RTLD_NOW);
  <span style=color:#66d9ef>auto</span> JNI_CreateJavaVM_f <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>decltype</span>(JNI_CreateJavaVM)<span style=color:#f92672>*&gt;</span>(dlsym(handler, <span style=color:#e6db74>&#34;JNI_CreateJavaVM&#34;</span>));
  JNI_CreateJavaVM_f(<span style=color:#f92672>&amp;</span>jvm, <span style=color:#f92672>&amp;</span>env, <span style=color:#f92672>&amp;</span>args);
}
</code></pre></div><p>Then, we can resolve the <code>gXftm3iswpkVgBNDUp</code> function with the base address of <code>libnative-lib.so</code>
and its offset <code>0x9B41C</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> hdl <span style=color:#f92672>=</span> dlopen(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>, RTLD_NOW);
uintptr_t base_address <span style=color:#f92672>=</span> get_base_address(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>);

<span style=color:#66d9ef>using</span> gXftm3iswpkVgBNDUp_t <span style=color:#f92672>=</span> jbyteArray(<span style=color:#f92672>*</span>)(JNIEnv<span style=color:#f92672>*</span>, jobject, jbyteArray, jbyte);
gXftm3iswpkVgBNDUp <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>gXftm3iswpkVgBNDUp_t<span style=color:#f92672>&gt;</span>(base_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x9B41C</span>);
</code></pre></div><p>Finally, we can run the function with our own inputs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>std<span style=color:#f92672>::</span>string pin_amount <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0000123400004567&#34;</span>;
jbyteArray array <span style=color:#f92672>=</span> convert_to_jbyteArray(pin_amount, ptr);
jbyteArray jencrypted_buffer <span style=color:#f92672>=</span> gXftm3iswpkVgBNDUp(env, <span style=color:#66d9ef>nullptr</span>, array, <span style=color:#ae81ff>0xF0</span>);
<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>&gt;</span> encrypted_buffer <span style=color:#f92672>=</span> from_jbytes(jencrypted_buffer);
std<span style=color:#f92672>::</span>string hex_str <span style=color:#f92672>=</span> to_hex(encrypted_buffer);
LOG_INFO(<span style=color:#e6db74>&#34;{} --&gt; {}&#34;</span>, pin_amount, ref_str);
</code></pre></div><div class="alert alert-note"><div>The whole implementation is available <a href=https://github.com/romainthomas/r2pay/blob/master/shim-whitebox>here <i class="fab fa-github"></i></a>.</div></div><h2 id=function-tracing>Function Tracing</h2><p>Now that we are able to run the <code>gXftm3iswpkVgBNDUp</code> function without the GUI layer, we can easily
create an interface with
<a href=https://qbdi.quarkslab.com target=_blank rel=noopener>QBDI</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>VM vm;
vm.addInstrumentedModule(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>);
...
jbyteArray array <span style=color:#f92672>=</span> to_jarray(pin_amount, ptr);
jbyteArray qbdi_encrypted_buffer;

vm.call(
    <span style=color:#75715e>/* ret    */</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>uintptr_t<span style=color:#f92672>*&gt;</span>(<span style=color:#f92672>&amp;</span>qbdi_encrypted_buffer),
    <span style=color:#75715e>/* target */</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>uintptr_t<span style=color:#f92672>&gt;</span>(gXftm3iswpkVgBNDUp),
    <span style=color:#75715e>/* params */</span> {
      <span style=color:#75715e>/* p_0: JNIEnv* */</span>      <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>rword<span style=color:#f92672>&gt;</span>(env),
      <span style=color:#75715e>/* p_1: jobject thiz */</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>rword<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>nullptr</span>),
      <span style=color:#75715e>/* p_2: inbuffer */</span>     <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>rword<span style=color:#f92672>&gt;</span>(array),
                              <span style=color:#ae81ff>0xF0</span>
  }
);
</code></pre></div><p>The execution in QBDI <strong>without user&rsquo;s callbacks</strong> takes about <strong>3min 30s</strong> which is quite huge compared to
the <strong>real execution</strong> that takes about <strong>853ms</strong>:</p><p><img src=benchmark.svg alt="Performances with different configurations"></p><p>This overhead is mostly due to the function <code>0x1038f0</code> that is executed ~20 000 times. After a quick
analysis, it turns out that this function is not relevant to instrument to break the whitebox.
We can force its <em>real</em> execution
(i.e. outside QBDI) <strong>by removing the function&rsquo;s address from the instrumented range</strong><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>constexpr</span> uintptr_t HEAVY_FUNCTION <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x1038f0</span>;
vm.removeInstrumentedRange(
  base_address <span style=color:#f92672>+</span> HEAVY_FUNCTION,
  base_address <span style=color:#f92672>+</span> HEAVY_FUNCTION <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
);
</code></pre></div><p>This small adjustment <strong>drops the execution to 3'30sec</strong>.</p><hr><p>Some cryptographic algorithms can be fingerprinted either with predefined constants or with their memory accesses.
According to the Quarkslab&rsquo;s blog post:
<a href=https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html target=_blank rel=noopener>Differential Fault Analysis on White-box AES Implementations</a>,
the whitebox lookup tables are likely to be stored in the <code>.data, .rodata, ...</code> sections.</p><p>By looking at the sizes of these sections, only the <code>.data</code> section seems to have an appropriate size.
We can generate a memory trace on this section to see if we can outline some patterns.
It can be made with the following piece of code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>vm.recordMemoryAccess(MEMORY_READ_WRITE);
vm.addMemRangeCB(
    <span style=color:#75715e>/* .data start address           */</span> base_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x127000</span>,
    <span style=color:#75715e>/* .data end address             */</span> base_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x127000</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x8e000</span>,
    <span style=color:#75715e>/* Record both: reads and writes */</span> MEMORY_READ_WRITE,

    <span style=color:#75715e>/* Memory callback */</span>
    [] (VM<span style=color:#f92672>*</span> vm, GPRState<span style=color:#f92672>*</span>, FPRState<span style=color:#f92672>*</span>, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> data) {
      <span style=color:#66d9ef>auto</span> ctx <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span>qbdi_ctx<span style=color:#f92672>*&gt;</span>(data);
      <span style=color:#75715e>/*
</span><span style=color:#75715e>       * &#39;for&#39; loop since on AArch64 we can have multiple reads / writes
</span><span style=color:#75715e>       * at once. (e.g. stp x0, x1, [sp, #128])
</span><span style=color:#75715e>       */</span>
      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> MemoryAccess<span style=color:#f92672>&amp;</span> mem_access : vm<span style=color:#f92672>-&gt;</span>getInstMemoryAccess()) {
        ctx<span style=color:#f92672>-&gt;</span>trace<span style=color:#f92672>-&gt;</span>push_back({
            mem_access.instAddress   <span style=color:#f92672>-</span> base_address,
            mem_access.accessAddress <span style=color:#f92672>-</span> base_address,
            mem_access.size,
        });
      }

      <span style=color:#66d9ef>return</span> VMAction<span style=color:#f92672>::</span>CONTINUE;
    }, <span style=color:#f92672>&amp;</span>ctx);
</code></pre></div><div class="alert alert-note"><div>Generating the memory trace takes about 11sec which is acceptable.</div></div><p>It leads to the following graph in which we can notice a characteristic pattern at the end of the trace:</p><p><img src=memory_trace.png alt="Memory trace generated with QBDI"></p><h2 id=fault-injection>Fault Injection</h2><p>The pattern at the end of the trace is quite characteristic of AES-128 where we can identify 10 rounds.
<img src=rounds.png alt="AES rounds"></p><p>We now have all the necessary information to make a <em>fault injection attack</em>:</p><ol><li>We can identify the 9th round</li><li>We can <strong>accurately</strong> fault the <code>.data</code> section thanks to the memory trace</li></ol><p><img src=injection.png alt="Fault injection in the 9th round"></p><div class="alert alert-note"><div>The memory trace is available in the <a href=https://github.com/romainthomas/r2pay/blob/master/assets/mem_trace.json><i class="fab fa-github"></i> mem_trace.json</a> file of the repository.</div></div><p>To efficiently make
the injection, we can first reduce the memory addresses to only keep those that are used in the last 2 rounds:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>trace_file <span style=color:#f92672>=</span> CWD <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;assets&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;mem_trace.json&#34;</span>
trace <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(trace_file<span style=color:#f92672>.</span>read_bytes())[<span style=color:#ae81ff>0</span>]

<span style=color:#75715e># Keep the entries that are involved in the last 2-rounds (empirical number)</span>
nice_trace <span style=color:#f92672>=</span> trace[<span style=color:#f92672>-</span><span style=color:#ae81ff>1000</span>:]
</code></pre></div><p>Then, we can use our shim mechanism to inject the faults in the <code>.data</code> section with the addresses previously selected.
Moreover, we can reduce the set of <code>.data</code> addresses with the faults that introduce exactly <strong>4 differences</strong> in the ciphertext:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>// Make sure the .data section is writable
</span><span style=color:#75715e></span>mprotect(
  <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>*&gt;</span>(base_address <span style=color:#f92672>+</span> <span style=color:#75715e>/* .data */</span> <span style=color:#ae81ff>0x127000</span>),
  <span style=color:#ae81ff>0x8e000</span>,
  PROT_READ <span style=color:#f92672>|</span> PROT_WRITE
);

<span style=color:#66d9ef>for</span> (uintptr_t fault_addr : selected_addresses) {
  <span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>&amp;</span> target_byte <span style=color:#f92672>=</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*&gt;</span>(base_address <span style=color:#f92672>+</span> fault_addr);
  <span style=color:#66d9ef>uint8_t</span> backup <span style=color:#f92672>=</span> target_byte;

  <span style=color:#75715e>// Fault 1 byte:
</span><span style=color:#75715e></span>  target_byte <span style=color:#f92672>^=</span> <span style=color:#ae81ff>0x33</span>;

  <span style=color:#75715e>// Run the whitebox with the faulty byte
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>&gt;</span> encrypted <span style=color:#f92672>=</span> encrypt(msg);

  <span style=color:#75715e>// Restore the original byte
</span><span style=color:#75715e></span>  target_byte <span style=color:#f92672>=</span> backup;

  <span style=color:#75715e>// Compute the number of errors
</span><span style=color:#75715e></span>  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>Finally, with the subset of the addresses that affect exactly 4 bytes, we can generate several faults for a given
address:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>for</span> (uintptr_t nice_fault_addr : four_bytes_fault_addresses) {
  <span style=color:#66d9ef>for</span> (size_t i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>255</span>; <span style=color:#f92672>++</span>i) {
    <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>&gt;&amp;</span> output <span style=color:#f92672>=</span> inject_fault(addr, PIN_AMOUNT, i);
    <span style=color:#66d9ef>const</span> size_t nb_errors <span style=color:#f92672>=</span> get_error(genuine_value, output);
    <span style=color:#66d9ef>if</span> (nb_errors <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span> and unique.insert(output).second) {
      <span style=color:#75715e>// Record the entry ...
</span><span style=color:#75715e></span>    }
  }
}
</code></pre></div><p>The aforementioned code gives an idea about how to generate the faults. One can find the whole implementation in
this file:
<a href=https://github.com/romainthomas/r2pay/blob/master/shim-whitebox/src/main.cpp#L343-L365 target=_blank rel=noopener>shim-whitebox/src/main.cpp</a> that produces
this set of files
<a href=https://github.com/romainthomas/r2pay/blob/master/assets/wb-traces target=_blank rel=noopener>assets/wb-traces</a>.</p><h2 id=key-extraction>Key Extraction</h2><p>Thanks to the
<a href=https://github.com/SideChannelMarvels target=_blank rel=noopener><i class="fab fa-github"></i> Side-Channel Marvels</a> project,
we can use
<a href=https://github.com/SideChannelMarvels/JeanGrey target=_blank rel=noopener>JeanGrey</a> &mdash; developed by Philippe Teuwen &mdash; to recover the whitebox&rsquo;s key from the faulty traces:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> pathlib
<span style=color:#f92672>import</span> phoenixAES

CWD <span style=color:#f92672>=</span> pathlib<span style=color:#f92672>.</span>Path(__file__)<span style=color:#f92672>.</span>parent
trace_dir <span style=color:#f92672>=</span> CWD <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;assets&#34;</span> <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;wb-traces&#34;</span>

<span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> trace_dir<span style=color:#f92672>.</span>iterdir():
    x <span style=color:#f92672>=</span> phoenixAES<span style=color:#f92672>.</span>crack_file(f)
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> None:
        <span style=color:#66d9ef>print</span>(x, f<span style=color:#f92672>.</span>name)
</code></pre></div><p>It provides the following results which enable to retrieve the key:</p><pre><code class=language-console data-lang=console>$ python wb_key_recovery.py
..8D....7F............9A....79.. injection-1a930d.trace
..8D....7F............9A....79.. injection-1a95bd.trace
....19....62....B0............8F injection-1a91b2.trace
....19....62....B0............8F injection-1a8fdf.trace
76............1E....D3....E1.... injection-1a8549.trace
......E1....A0....CD....28...... injection-1a8978.trace
....19....62....B0............8F injection-1a90ce.trace
....19....62....B0............8F injection-1a8efd.trace
r 2 p 4 y 1 s N 0 w S e c u r 3
</code></pre><p>Finally, we can verify that <strong>r2p4y1sN0wSecur3</strong> is the right key by trying to decrypt <code>9497cdf1df2600e7f63778d0ae91dcbb</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
WB_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;r2p4y1sN0wSecur3&#34;</span>

cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(WB_KEY, AES<span style=color:#f92672>.</span>MODE_ECB)
output <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>decrypt(bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;9497cdf1df2600e7f63778d0ae91dcbb&#34;</span>))
<span style=color:#66d9ef>print</span>(output<span style=color:#f92672>.</span>decode())
</code></pre></div><pre><code class=language-console data-lang=console>$ python ./aes_test.py
0000123400004567
</code></pre><h2 id=side-note-about-the-data-section>Side note about the <code>.data</code> section</h2><p>Most of the obfuscators encode strings so that we don&rsquo;t have any clue about functions' logic. The obfuscator
used in the challenge follows this rule and running the <code>strings</code> utility on the library does not reveal any interesting information.</p><p>Nevertheless, we can find a lot of <code>.datadiv_decode&lt;random hex></code> in the ELF constructors of the library.
As explained in the previous part, they are generated by the obfuscator and aimed to decode the strings.</p><p>Since these functions are in the <strong>ELF constructors</strong>, this means that they are executed as soon as the library is loaded.
In particular, when calling <code>dlopen(...)</code> these constructors are executed. It can be confirmed by
dumping the <code>.data</code> section right after <code>dlopen()</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>dlopen(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>, RTLD_NOW);
std<span style=color:#f92672>::</span>ofstream ofs{fmt<span style=color:#f92672>::</span>format(<span style=color:#e6db74>&#34;/data/local/tmp/{}&#34;</span>, output)};
<span style=color:#66d9ef>auto</span> start <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*&gt;</span>(base_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x127000</span>);
ofs.write(start, <span style=color:#75715e>/* sizeof(.data) */</span> <span style=color:#ae81ff>0x8d49f</span>);
</code></pre></div><p>Then, we can compare the bytes distribution with
<a href=https://binvis.io/ target=_blank rel=noopener>binvis.io</a>:</p><p><img src=data_strings.png alt="Bytes distribution in the .data section"></p><p>At the end of the in-memory <code>.data</code> section, we can found interesting strings used to detect Frida and the
device&rsquo;s root state.</p><h2 id=conclusion>Conclusion</h2><p>Thanks again to <u>Eduardo Novella</u> (
<a href=https://twitter.com/enovella_ target=_blank rel=noopener>@enovella_</a>)
and <u>Gautam Arvind</u> (
<a href=https://twitter.com/darvincisec target=_blank rel=noopener>@darvincisec</a>) for this second part of the challenge :)</p><p>Also thanks to <u><a href=https://www.quarkslab.com target=_blank rel=noopener>Quarkslab</a></u> that allowed this publication.
One can find related blog posts about whitebox attacks on the Quarkslab&rsquo;s blog:</p><ul><li><p><a href=https://blog.quarkslab.com/introduction-to-whiteboxes-and-collision-based-attacks-with-qbdi.html target=_blank rel=noopener>Introduction to Whiteboxes and Collision-Based Attacks With QBDI</a> by Paul Hernault (
<a href=https://twitter.com/0xAcid target=_blank rel=noopener>@0xAcid</a>)</p></li><li><p><a href=https://blog.quarkslab.com/when-sidechannelmarvels-meet-lief.html target=_blank rel=noopener>When SideChannelMarvels meet LIEF</a></p></li><li><p><a href=https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html target=_blank rel=noopener>Differential Fault Analysis on White-box AES
Implementations</a> by Philippe Teuwen (
<a href=https://twitter.com/doegox target=_blank rel=noopener>@doegox</a>).
<em>I used this blog post as a reference to resolve this part of the challenge.</em></p></li></ul><h3 id=references>References</h3><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://developer.android.com/reference/android/content/Context>https://developer.android.com/reference/android/content/Context</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/>https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>QBDI will execute the function using the
<a href=https://qbdi.readthedocs.io/en/stable/api_cpp.html#execution-filtering target=_blank rel=noopener>ExecBroker</a> mechanism.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>It is the output of the function when entering <code>1234</code> in the PIN field and <code>4567</code> in the amount field.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=article-tags><a class="badge badge-light" href=/tags/android/>android</a>
<a class="badge badge-light" href=/tags/reverse-engineering/>reverse engineering</a>
<a class="badge badge-light" href=/tags/write-up/>write-up</a>
<a class="badge badge-light" href=/tags/obfuscation/>obfuscation</a>
<a class="badge badge-light" href=/tags/whitebox/>whitebox</a>
<a class="badge badge-light" href=/tags/cryptography/>cryptography</a></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/armasm.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.f6ecf7692215f2bc4850b72c8176bfa2.js></script><div class=container><footer class=site-footer><p class=powered-by>Published with <a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic Website Builder</a> - Icons made by <a href=http://www.freepik.com/ title=Freepik>Freepik</a></p><p class=powered-by><span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>