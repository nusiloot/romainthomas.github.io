<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=generator content="Source Themes Academic 4.8.0">
<meta name=description content="This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so">
<link rel=alternate hreflang=en-us href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/>
<meta name=theme-color content="#2962ff">
<script src=/js/mathjax-config.js></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-light>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-dark disabled>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous>
<script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
<script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono%7CFira+Code&display=swap">
<link rel=stylesheet href=/css/academic.css>
<link href=https://www.romainthomas.fr/post/index.xml rel=feed type=application/rss+xml title="Blog Posts | Romain Thomas">
<link href=https://www.romainthomas.fr/post/index.xml rel=alternate type=application/rss+xml title="Blog Posts | Romain Thomas">
<link rel=manifest href=/index.webmanifest>
<link rel=icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_32x32_fill_lanczos_center_3.png>
<link rel=apple-touch-icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_3.png>
<link rel=canonical href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/>
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:site" content="@rh0main">
<meta property="twitter:creator" content="@rh0main">
<meta property="og:site_name" content="Romain Thomas">
<meta property="og:url" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/">
<meta property="og:title" content="r2-pay: whitebox (part 2) | Romain Thomas">
<meta property="og:description" content="This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so"><meta property="og:image" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png">
<meta property="twitter:image" content="https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png"><meta property="og:locale" content="en-us">
<meta property="article:published_time" content="2020-09-27T00:00:00+00:00">
<meta property="article:modified_time" content="2020-09-27T00:00:00+00:00">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/"},"headline":"r2-pay: whitebox (part 2)","image":["https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/featured.png"],"datePublished":"2020-09-27T00:00:00Z","dateModified":"2020-09-27T00:00:00Z","author":{"@type":"Person","name":"Romain Thomas"},"publisher":{"@type":"Organization","name":"Romain Thomas","logo":{"@type":"ImageObject","url":"https://www.romainthomas.fr/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_3.png"}},"description":"This second blog post explains how to recover the whitebox's key from the obfuscated library libnative-lib.so"}</script>
<title>r2-pay: whitebox (part 2) | Romain Thomas</title>
</head>
<body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents>
<aside class=search-results id=search>
<div class=container>
<section class=search-header>
<div class="row no-gutters justify-content-between mb-3">
<div class=col-6>
<h1>Search</h1>
</div>
<div class="col-6 col-search-close">
<a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a>
</div>
</div>
<div id=search-box>
<input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control>
</div>
</section>
<section class=section-search-results>
<div id=search-hits>
</div>
</section>
</div>
</aside>
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
<div class=container>
<div class="d-none d-lg-inline-flex">
<a class=navbar-brand href=/>Romain Thomas</a>
</div>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span>
</button>
<div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
<a class=navbar-brand href=/>Romain Thomas</a>
</div>
<div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content>
<ul class="navbar-nav d-md-inline-flex">
<li class=nav-item>
<a class=nav-link href=/#about><span>Home</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#publications><span>Publications</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#posts><span>Posts</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#projects><span>Projects</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#projects-images><span>Gallery</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#work-experience><span>Work experience</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#contact><span>Contact</span></a>
</li>
</ul>
</div>
<ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
<li class=nav-item>
<a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a>
</li>
</ul>
</div>
</nav>
<article class=article>
<div class="article-container pt-3">
<h1>r2-pay: whitebox (part 2)</h1>
<div class=article-metadata>
<div>
<span>Romain Thomas</span>
</div>
<span class=article-date>
Sep 27, 2020
</span>
<span class=middot-divider></span>
<span class=article-reading-time>
8 min read
</span>
<span class=middot-divider></span>
<span class=article-categories>
<i class="fas fa-folder mr-1"></i><a href=/categories/android/>Android</a>, <a href=/categories/reverse-engineering/>Reverse Engineering</a></span>
</div>
</div>
<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:390px>
<div style=position:relative>
<img src=/post/20-09-r2con-obfuscated-whitebox-part2/featured_hu10c4b997cebf9fd3ba89cc6ffc564a2f_256619_720x0_resize_lanczos_3.png alt class=featured-image>
</div>
</div>
<div class=article-container>
<div class=article-style>
<style>.green{color:green;font-family:fira code,monospace;font-size:87.5%}.blue{color:blue;font-family:fira code,monospace;font-size:87.5%}.orange{color:tomato;font-family:fira code,monospace;font-size:87.5%}.red{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-comment{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-keyword{color:#a90d91;font-family:fira code,monospace;font-size:87.5%}.hl-literal{color:#1c01ce;font-family:fira code,monospace;font-size:87.5%}.hl-preproc{color:#633820;font-family:fira code,monospace;font-size:87.5%}.hl-strings{color:#c41a16;font-family:fira code,monospace;font-size:87.5%}.yellow{color:#cc7000;font-family:fira code,monospace;font-size:87.5%}#</style>
<h2 id=introduction>Introduction</h2>
<p>In the
<a href=/post/20-09-r2con-obfuscated-whitebox-part1/>first part</a> of this write-up, we described the
anti-frida, anti-debug and anti-root techniques used in the application and how to remove most of them.</p>
<p>This second part digs into the JNI function <code>gXftm3iswpkVgBNDUp</code> and the underlying whitebox implementation.</p>
<h2 id=library-shimming>Library Shimming</h2>
<p>The inputs of the function <code>gXftm3iswpkVgBNDUp</code> are provided by the GUI widgets and the function
is triggered when we press the <em>Generate R2Coin</em> button.
Nevertheless, the behavior of <code>gXftm3iswpkVgBNDUp</code> does not rely on UI features nor
the application&rsquo;s context<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p>
<p>To take a closer look at the logic of <code>gXftm3iswpkVgBNDUp</code>, it would be pretty useful to be able to feed
the function&rsquo;s inputs with our <strong>own standalone binary</strong>. Basically, we would like to achieve this kind
of interface:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>void</span><span class=o>*</span> <span class=n>dlopen</span><span class=p>(</span><span class=s>&#34;libnative-lib.so&#34;</span><span class=p>,</span> <span class=n>RTLD_NOW</span><span class=p>);</span>
  <span class=p>...</span>
  <span class=n>jbyteArray</span> <span class=n>out</span> <span class=o>=</span> <span class=n>gXftm3iswpkVgBNDUp</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=p>...);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This technique is not new and has been already described in a blog post by
<a href=https://twitter.com/caleb_fenton target=_blank rel=noopener>Caleb Fenton</a><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. The idea is to get
the <code>JNIEnv* env</code> variable with <code>JNI_CreateJavaVM</code> which is exported by the Android runtime: <code>libart.so</code>.</p>
<p>Once we have this variable, we can call the <code>gXftm3iswpkVgBNDUp</code> function as well as manipulating the JNI buffers:</p>
<ul>
<li><code>env->NewByteArray()</code></li>
<li><code>env->GetArrayLength()</code></li>
<li>&mldr;</li>
</ul>
<p><img src=shim_mechanism.png alt="Shimming of whitebox library"></p>
<p>Long story short, we can instantiate the Android runtime with the following piece of code:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>JavaVMOption</span> <span class=n>opt</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
  <span class=n>opt</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>optionString</span> <span class=o>=</span> <span class=s>&#34;-Djava.class.path=/data/local/tmp/re.pwnme.1.0.apk&#34;</span><span class=p>;</span>
  <span class=n>opt</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>optionString</span> <span class=o>=</span> <span class=s>&#34;-Djava.library.path=/data/local/tmp&#34;</span><span class=p>;</span>

  <span class=n>JavaVMInitArgs</span> <span class=n>args</span><span class=p>;</span>
  <span class=n>args</span><span class=p>.</span><span class=n>version</span>            <span class=o>=</span> <span class=n>JNI_VERSION_1_6</span><span class=p>;</span>
  <span class=n>args</span><span class=p>.</span><span class=n>options</span>            <span class=o>=</span> <span class=n>opt</span><span class=p>;</span>
  <span class=n>args</span><span class=p>.</span><span class=n>nOptions</span>           <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
  <span class=n>args</span><span class=p>.</span><span class=n>ignoreUnrecognized</span> <span class=o>=</span> <span class=n>JNI_FALSE</span><span class=p>;</span>

  <span class=kt>void</span><span class=o>*</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>dlopen</span><span class=p>(</span><span class=s>&#34;/system/lib64/libart.so&#34;</span><span class=p>,</span> <span class=n>RTLD_NOW</span><span class=p>);</span>
  <span class=k>auto</span> <span class=n>JNI_CreateJavaVM_f</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>JNI_CreateJavaVM</span><span class=p>)</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>dlsym</span><span class=p>(</span><span class=n>handler</span><span class=p>,</span> <span class=s>&#34;JNI_CreateJavaVM&#34;</span><span class=p>));</span>
  <span class=n>JNI_CreateJavaVM_f</span><span class=p>(</span><span class=o>&amp;</span><span class=n>jvm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>env</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>args</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Then, we can resolve the <code>gXftm3iswpkVgBNDUp</code> function with the base address of <code>libnative-lib.so</code>
and its offset <code>0x9B41C</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>void</span><span class=o>*</span> <span class=n>hdl</span> <span class=o>=</span> <span class=n>dlopen</span><span class=p>(</span><span class=s>&#34;libnative-lib.so&#34;</span><span class=p>,</span> <span class=n>RTLD_NOW</span><span class=p>);</span>
<span class=n>uintptr_t</span> <span class=n>base_address</span> <span class=o>=</span> <span class=n>get_base_address</span><span class=p>(</span><span class=s>&#34;libnative-lib.so&#34;</span><span class=p>);</span>

<span class=k>using</span> <span class=n>gXftm3iswpkVgBNDUp_t</span> <span class=o>=</span> <span class=n>jbyteArray</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=p>,</span> <span class=n>jobject</span><span class=p>,</span> <span class=n>jbyteArray</span><span class=p>,</span> <span class=n>jbyte</span><span class=p>);</span>
<span class=n>gXftm3iswpkVgBNDUp</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>gXftm3iswpkVgBNDUp_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>base_address</span> <span class=o>+</span> <span class=mh>0x9B41C</span><span class=p>);</span>
</code></pre></div><p>Finally, we can run the function with our own inputs:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>pin_amount</span> <span class=o>=</span> <span class=s>&#34;0000123400004567&#34;</span><span class=p>;</span>
<span class=n>jbyteArray</span> <span class=n>array</span> <span class=o>=</span> <span class=n>convert_to_jbyteArray</span><span class=p>(</span><span class=n>pin_amount</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
<span class=n>jbyteArray</span> <span class=n>jencrypted_buffer</span> <span class=o>=</span> <span class=n>gXftm3iswpkVgBNDUp</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>,</span> <span class=n>array</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>);</span>
<span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;</span> <span class=n>encrypted_buffer</span> <span class=o>=</span> <span class=n>from_jbytes</span><span class=p>(</span><span class=n>jencrypted_buffer</span><span class=p>);</span>
<span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>hex_str</span> <span class=o>=</span> <span class=n>to_hex</span><span class=p>(</span><span class=n>encrypted_buffer</span><span class=p>);</span>
<span class=n>LOG_INFO</span><span class=p>(</span><span class=s>&#34;{} --&gt; {}&#34;</span><span class=p>,</span> <span class=n>pin_amount</span><span class=p>,</span> <span class=n>ref_str</span><span class=p>);</span>
</code></pre></div><div class="alert alert-note">
<div>
The whole implementation is available <a href=https://github.com/romainthomas/r2pay/blob/master/shim-whitebox>here <i class="fab fa-github"></i></a>.
</div>
</div>
<h2 id=function-tracing>Function Tracing</h2>
<p>Now that we are able to run the <code>gXftm3iswpkVgBNDUp</code> function without the GUI layer, we can easily
create an interface with
<a href=https://qbdi.quarkslab.com target=_blank rel=noopener>QBDI</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>VM</span> <span class=n>vm</span><span class=p>;</span>
<span class=n>vm</span><span class=p>.</span><span class=n>addInstrumentedModule</span><span class=p>(</span><span class=s>&#34;libnative-lib.so&#34;</span><span class=p>);</span>
<span class=p>...</span>
<span class=n>jbyteArray</span> <span class=n>array</span> <span class=o>=</span> <span class=n>to_jarray</span><span class=p>(</span><span class=n>pin_amount</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
<span class=n>jbyteArray</span> <span class=n>qbdi_encrypted_buffer</span><span class=p>;</span>

<span class=n>vm</span><span class=p>.</span><span class=n>call</span><span class=p>(</span>
    <span class=cm>/* ret    */</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>uintptr_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>qbdi_encrypted_buffer</span><span class=p>),</span>
    <span class=cm>/* target */</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>uintptr_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>gXftm3iswpkVgBNDUp</span><span class=p>),</span>
    <span class=cm>/* params */</span> <span class=p>{</span>
      <span class=cm>/* p_0: JNIEnv* */</span>      <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>rword</span><span class=o>&gt;</span><span class=p>(</span><span class=n>env</span><span class=p>),</span>
      <span class=cm>/* p_1: jobject thiz */</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>rword</span><span class=o>&gt;</span><span class=p>(</span><span class=k>nullptr</span><span class=p>),</span>
      <span class=cm>/* p_2: inbuffer */</span>     <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>rword</span><span class=o>&gt;</span><span class=p>(</span><span class=n>array</span><span class=p>),</span>
                              <span class=mh>0xF0</span>
  <span class=p>}</span>
<span class=p>);</span>
</code></pre></div><p>The execution in QBDI <strong>without user&rsquo;s callbacks</strong> takes about <strong>3min 30s</strong> which is quite huge compared to
the <strong>real execution</strong> that takes about <strong>853ms</strong>:</p>
<p><img src=benchmark.svg alt="Performances with different configurations"></p>
<p>This overhead is mostly due to the function <code>0x1038f0</code> that is executed ~20 000 times. After a quick
analysis, it turns out that this function is not relevant to instrument to break the whitebox.
We can force its <em>real</em> execution
(i.e. outside QBDI) <strong>by removing the function&rsquo;s address from the instrumented range</strong><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>static</span> <span class=k>constexpr</span> <span class=n>uintptr_t</span> <span class=n>HEAVY_FUNCTION</span> <span class=o>=</span> <span class=mh>0x1038f0</span><span class=p>;</span>
<span class=n>vm</span><span class=p>.</span><span class=n>removeInstrumentedRange</span><span class=p>(</span>
  <span class=n>base_address</span> <span class=o>+</span> <span class=n>HEAVY_FUNCTION</span><span class=p>,</span>
  <span class=n>base_address</span> <span class=o>+</span> <span class=n>HEAVY_FUNCTION</span> <span class=o>+</span> <span class=mi>1</span>
<span class=p>);</span>
</code></pre></div><p>This small adjustment <strong>drops the execution to 3'30sec</strong>.</p>
<hr>
<p>Some cryptographic algorithms can be fingerprinted either with predefined constants or with their memory accesses.
According to the Quarkslab&rsquo;s blog post:
<a href=https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html target=_blank rel=noopener>Differential Fault Analysis on White-box AES Implementations</a>,
the whitebox lookup tables are likely to be stored in the <code>.data, .rodata, ...</code> sections.</p>
<p>By looking at the sizes of these sections, only the <code>.data</code> section seems to have an appropriate size.
We can generate a memory trace on this section to see if we can outline some patterns.
It can be made with the following piece of code:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>vm</span><span class=p>.</span><span class=n>recordMemoryAccess</span><span class=p>(</span><span class=n>MEMORY_READ_WRITE</span><span class=p>);</span>
<span class=n>vm</span><span class=p>.</span><span class=n>addMemRangeCB</span><span class=p>(</span>
    <span class=cm>/* .data start address           */</span> <span class=n>base_address</span> <span class=o>+</span> <span class=mh>0x127000</span><span class=p>,</span>
    <span class=cm>/* .data end address             */</span> <span class=n>base_address</span> <span class=o>+</span> <span class=mh>0x127000</span> <span class=o>+</span> <span class=mh>0x8e000</span><span class=p>,</span>
    <span class=cm>/* Record both: reads and writes */</span> <span class=n>MEMORY_READ_WRITE</span><span class=p>,</span>

    <span class=cm>/* Memory callback */</span>
    <span class=p>[]</span> <span class=p>(</span><span class=n>VM</span><span class=o>*</span> <span class=n>vm</span><span class=p>,</span> <span class=n>GPRState</span><span class=o>*</span><span class=p>,</span> <span class=n>FPRState</span><span class=o>*</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>auto</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>qbdi_ctx</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
      <span class=cm>/*
</span><span class=cm>       * &#39;for&#39; loop since on AArch64 we can have multiple reads / writes
</span><span class=cm>       * at once. (e.g. stp x0, x1, [sp, #128])
</span><span class=cm>       */</span>
      <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=n>MemoryAccess</span><span class=o>&amp;</span> <span class=nl>mem_access</span> <span class=p>:</span> <span class=n>vm</span><span class=o>-&gt;</span><span class=n>getInstMemoryAccess</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>ctx</span><span class=o>-&gt;</span><span class=n>trace</span><span class=o>-&gt;</span><span class=n>push_back</span><span class=p>({</span>
            <span class=n>mem_access</span><span class=p>.</span><span class=n>instAddress</span>   <span class=o>-</span> <span class=n>base_address</span><span class=p>,</span>
            <span class=n>mem_access</span><span class=p>.</span><span class=n>accessAddress</span> <span class=o>-</span> <span class=n>base_address</span><span class=p>,</span>
            <span class=n>mem_access</span><span class=p>.</span><span class=n>size</span><span class=p>,</span>
        <span class=p>});</span>
      <span class=p>}</span>

      <span class=k>return</span> <span class=n>VMAction</span><span class=o>::</span><span class=n>CONTINUE</span><span class=p>;</span>
    <span class=p>},</span> <span class=o>&amp;</span><span class=n>ctx</span><span class=p>);</span>
</code></pre></div><div class="alert alert-note">
<div>
Generating the memory trace takes about 11sec which is acceptable.
</div>
</div>
<p>It leads to the following graph in which we can notice a characteristic pattern at the end of the trace:</p>
<p><img src=memory_trace.png alt="Memory trace generated with QBDI"></p>
<h2 id=fault-injection>Fault Injection</h2>
<p>The pattern at the end of the trace is quite characteristic of AES-128 where we can identify 10 rounds.
<img src=rounds.png alt="AES rounds"></p>
<p>We now have all the necessary information to make a <em>fault injection attack</em>:</p>
<ol>
<li>We can identify the 9th round</li>
<li>We can <strong>accurately</strong> fault the <code>.data</code> section thanks to the memory trace</li>
</ol>
<p><img src=injection.png alt="Fault injection in the 9th round"></p>
<div class="alert alert-note">
<div>
The memory trace is available in the <a href=https://github.com/romainthomas/r2pay/blob/master/assets/mem_trace.json><i class="fab fa-github"></i> mem_trace.json</a> file of the repository.
</div>
</div>
<p>To efficiently make
the injection, we can first reduce the memory addresses to only keep those that are used in the last 2 rounds:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>trace_file</span> <span class=o>=</span> <span class=n>CWD</span> <span class=o>/</span> <span class=s2>&#34;..&#34;</span> <span class=o>/</span> <span class=s2>&#34;assets&#34;</span> <span class=o>/</span> <span class=s2>&#34;mem_trace.json&#34;</span>
<span class=n>trace</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>trace_file</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>())[</span><span class=mi>0</span><span class=p>]</span>

<span class=c1># Keep the entries that are involved in the last 2-rounds (empirical number)</span>
<span class=n>nice_trace</span> <span class=o>=</span> <span class=n>trace</span><span class=p>[</span><span class=o>-</span><span class=mi>1000</span><span class=p>:]</span>
</code></pre></div><p>Then, we can use our shim mechanism to inject the faults in the <code>.data</code> section with the addresses previously selected.
Moreover, we can reduce the set of <code>.data</code> addresses with the faults that introduce exactly <strong>4 differences</strong> in the ciphertext:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=c1>// Make sure the .data section is writable
</span><span class=c1></span><span class=n>mprotect</span><span class=p>(</span>
  <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>base_address</span> <span class=o>+</span> <span class=cm>/* .data */</span> <span class=mh>0x127000</span><span class=p>),</span>
  <span class=mh>0x8e000</span><span class=p>,</span>
  <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span>
<span class=p>);</span>

<span class=k>for</span> <span class=p>(</span><span class=n>uintptr_t</span> <span class=nl>fault_addr</span> <span class=p>:</span> <span class=n>selected_addresses</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>uint8_t</span><span class=o>&amp;</span> <span class=n>target_byte</span> <span class=o>=</span> <span class=o>*</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>base_address</span> <span class=o>+</span> <span class=n>fault_addr</span><span class=p>);</span>
  <span class=kt>uint8_t</span> <span class=n>backup</span> <span class=o>=</span> <span class=n>target_byte</span><span class=p>;</span>

  <span class=c1>// Fault 1 byte:
</span><span class=c1></span>  <span class=n>target_byte</span> <span class=o>^=</span> <span class=mh>0x33</span><span class=p>;</span>

  <span class=c1>// Run the whitebox with the faulty byte
</span><span class=c1></span>  <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;</span> <span class=n>encrypted</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>

  <span class=c1>// Restore the original byte
</span><span class=c1></span>  <span class=n>target_byte</span> <span class=o>=</span> <span class=n>backup</span><span class=p>;</span>

  <span class=c1>// Compute the number of errors
</span><span class=c1></span>  <span class=c1>// ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>Finally, with the subset of the addresses that affect exactly 4 bytes, we can generate several faults for a given
address:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>for</span> <span class=p>(</span><span class=n>uintptr_t</span> <span class=nl>nice_fault_addr</span> <span class=p>:</span> <span class=n>four_bytes_fault_addresses</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>255</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&amp;</span> <span class=n>output</span> <span class=o>=</span> <span class=n>inject_fault</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>PIN_AMOUNT</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
    <span class=k>const</span> <span class=n>size_t</span> <span class=n>nb_errors</span> <span class=o>=</span> <span class=n>get_error</span><span class=p>(</span><span class=n>genuine_value</span><span class=p>,</span> <span class=n>output</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>nb_errors</span> <span class=o>==</span> <span class=mi>4</span> <span class=n>and</span> <span class=n>unique</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>output</span><span class=p>).</span><span class=n>second</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Record the entry ...
</span><span class=c1></span>    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>The aforementioned code gives an idea about how to generate the faults. One can find the whole implementation in
this file:
<a href=https://github.com/romainthomas/r2pay/blob/master/shim-whitebox/src/main.cpp#L343-L365 target=_blank rel=noopener>shim-whitebox/src/main.cpp</a> that produces
this set of files
<a href=https://github.com/romainthomas/r2pay/blob/master/assets/wb-traces target=_blank rel=noopener>assets/wb-traces</a>.</p>
<h2 id=key-extraction>Key Extraction</h2>
<p>Thanks to the
<a href=https://github.com/SideChannelMarvels target=_blank rel=noopener><i class="fab fa-github"></i> Side-Channel Marvels</a> project,
we can use
<a href=https://github.com/SideChannelMarvels/JeanGrey target=_blank rel=noopener>JeanGrey</a> &mdash; developed by Philippe Teuwen &mdash; to recover the whitebox&rsquo;s key from the faulty traces:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pathlib</span>
<span class=kn>import</span> <span class=nn>phoenixAES</span>

<span class=n>CWD</span> <span class=o>=</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=vm>__file__</span><span class=p>)</span><span class=o>.</span><span class=n>parent</span>
<span class=n>trace_dir</span> <span class=o>=</span> <span class=n>CWD</span> <span class=o>/</span> <span class=s2>&#34;..&#34;</span> <span class=o>/</span> <span class=s2>&#34;assets&#34;</span> <span class=o>/</span> <span class=s2>&#34;wb-traces&#34;</span>

<span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>trace_dir</span><span class=o>.</span><span class=n>iterdir</span><span class=p>():</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>phoenixAES</span><span class=o>.</span><span class=n>crack_file</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>f</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</code></pre></div><p>It provides the following results which enable to retrieve the key:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>python wb_key_recovery.py
<span class=go>..8D....7F............9A....79.. injection-1a930d.trace
</span><span class=go>..8D....7F............9A....79.. injection-1a95bd.trace
</span><span class=go>....19....62....B0............8F injection-1a91b2.trace
</span><span class=go>....19....62....B0............8F injection-1a8fdf.trace
</span><span class=go>76............1E....D3....E1.... injection-1a8549.trace
</span><span class=go>......E1....A0....CD....28...... injection-1a8978.trace
</span><span class=go>....19....62....B0............8F injection-1a90ce.trace
</span><span class=go>....19....62....B0............8F injection-1a8efd.trace
</span><span class=go>r 2 p 4 y 1 s N 0 w S e c u r 3
</span></code></pre></div><p>Finally, we can verify that <strong>r2p4y1sN0wSecur3</strong> is the right key by trying to decrypt <code>9497cdf1df2600e7f63778d0ae91dcbb</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
<span class=n>WB_KEY</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;r2p4y1sN0wSecur3&#34;</span>

<span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>WB_KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
<span class=n>output</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;9497cdf1df2600e7f63778d0ae91dcbb&#34;</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>python ./aes_test.py
<span class=go>0000123400004567
</span></code></pre></div><h2 id=side-note-about-the-data-section>Side note about the <code>.data</code> section</h2>
<p>Most of the obfuscators encode strings so that we don&rsquo;t have any clue about functions' logic. The obfuscator
used in the challenge follows this rule and running the <code>strings</code> utility on the library does not reveal any interesting information.</p>
<p>Nevertheless, we can find a lot of <code>.datadiv_decode&lt;random hex></code> in the ELF constructors of the library.
As explained in the previous part, they are generated by the obfuscator and aimed to decode the strings.</p>
<p>Since these functions are in the <strong>ELF constructors</strong>, this means that they are executed as soon as the library is loaded.
In particular, when calling <code>dlopen(...)</code> these constructors are executed. It can be confirmed by
dumping the <code>.data</code> section right after <code>dlopen()</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>dlopen</span><span class=p>(</span><span class=s>&#34;libnative-lib.so&#34;</span><span class=p>,</span> <span class=n>RTLD_NOW</span><span class=p>);</span>
<span class=n>std</span><span class=o>::</span><span class=n>ofstream</span> <span class=n>ofs</span><span class=p>{</span><span class=n>fmt</span><span class=o>::</span><span class=n>format</span><span class=p>(</span><span class=s>&#34;/data/local/tmp/{}&#34;</span><span class=p>,</span> <span class=n>output</span><span class=p>)};</span>
<span class=k>auto</span> <span class=n>start</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span> <span class=kt>char</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>base_address</span> <span class=o>+</span> <span class=mh>0x127000</span><span class=p>);</span>
<span class=n>ofs</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=cm>/* sizeof(.data) */</span> <span class=mh>0x8d49f</span><span class=p>);</span>
</code></pre></div><p>Then, we can compare the bytes distribution with
<a href=https://binvis.io/ target=_blank rel=noopener>binvis.io</a>:</p>
<p><img src=data_strings.png alt="Bytes distribution in the .data section"></p>
<p>At the end of the in-memory <code>.data</code> section, we can found interesting strings used to detect Frida and the
device&rsquo;s root state.</p>
<h2 id=conclusion>Conclusion</h2>
<p>Thanks again to <u>Eduardo Novella</u> (
<a href=https://twitter.com/enovella_ target=_blank rel=noopener>@enovella_</a>)
and <u>Gautam Arvind</u> (
<a href=https://twitter.com/darvincisec target=_blank rel=noopener>@darvincisec</a>) for this second part of the challenge :)</p>
<p>Also thanks to <u>
<a href=https://www.quarkslab.com target=_blank rel=noopener>Quarkslab</a></u> that allowed this publication.
One can find related blog posts about whitebox attacks on the Quarkslab&rsquo;s blog:</p>
<ul>
<li>
<p>
<a href=https://blog.quarkslab.com/introduction-to-whiteboxes-and-collision-based-attacks-with-qbdi.html target=_blank rel=noopener>Introduction to Whiteboxes and Collision-Based Attacks With QBDI
</a> by Paul Hernault (
<a href=https://twitter.com/0xAcid target=_blank rel=noopener>@0xAcid</a>)</p>
</li>
<li>
<p>
<a href=https://blog.quarkslab.com/when-sidechannelmarvels-meet-lief.html target=_blank rel=noopener>When SideChannelMarvels meet LIEF </a></p>
</li>
<li>
<p>
<a href=https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html target=_blank rel=noopener>Differential Fault Analysis on White-box AES
Implementations</a> by Philippe Teuwen (
<a href=https://twitter.com/doegox target=_blank rel=noopener>@doegox</a>).
<em>I used this blog post as a reference to resolve this part of the challenge.</em></p>
</li>
</ul>
<h3 id=references>References</h3>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>
<a href=https://developer.android.com/reference/android/content/Context target=_blank rel=noopener>https://developer.android.com/reference/android/content/Context</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p>
<a href=https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/ target=_blank rel=noopener>https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p>QBDI will execute the function using the
<a href=https://qbdi.readthedocs.io/en/stable/api_cpp.html#execution-filtering target=_blank rel=noopener>ExecBroker</a> mechanism.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p>It is the output of the function when entering <code>1234</code> in the PIN field and <code>4567</code> in the amount field.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<div class=article-tags>
<a class="badge badge-light" href=/tags/android/>android</a>
<a class="badge badge-light" href=/tags/reverse-engineering/>reverse engineering</a>
<a class="badge badge-light" href=/tags/write-up/>write-up</a>
<a class="badge badge-light" href=/tags/obfuscation/>obfuscation</a>
<a class="badge badge-light" href=/tags/whitebox/>whitebox</a>
<a class="badge badge-light" href=/tags/cryptography/>cryptography</a>
</div>
</div>
</article>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/armasm.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script>
<script>const code_highlighting=!0</script>
<script>const isSiteThemeDark=!1</script>
<script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script>
<script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script>
<script src=/js/academic.min.f6ecf7692215f2bc4850b72c8176bfa2.js></script>
<div class=container>
<footer class=site-footer>
<p class=powered-by>
Published with <a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic Website Builder</a>
</p>
<p class=powered-by>
<span class=float-right aria-hidden=true>
<a href=# class=back-to-top>
<span class=button_icon>
<i class="fas fa-chevron-up fa-2x"></i>
</span>
</a>
</span>
</p>
</footer>
</div>
<div id=modal class="modal fade" role=dialog>
<div class=modal-dialog>
<div class=modal-content>
<div class=modal-header>
<h5 class=modal-title>Cite</h5>
<button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span>
</button>
</div>
<div class=modal-body>
<pre><code class="tex hljs"></code></pre>
</div>
<div class=modal-footer>
<a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank>
<i class="fas fa-copy"></i> Copy
</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank>
<i class="fas fa-download"></i> Download
</a>
<div id=modal-error></div>
</div>
</div>
</div>
</div>
</body>
</html>