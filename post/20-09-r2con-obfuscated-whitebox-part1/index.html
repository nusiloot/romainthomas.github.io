<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="This first blog post describes the protections in the challenge r2-pay."><link rel=alternate hreflang=en-us href=/post/20-09-r2con-obfuscated-whitebox-part1/><meta name=theme-color content="#2962ff"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono%7CFira+Code&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_2.png><link rel=canonical href=/post/20-09-r2con-obfuscated-whitebox-part1/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@rh0main"><meta property="twitter:creator" content="@rh0main"><meta property="og:site_name" content="Romain Thomas"><meta property="og:url" content="/post/20-09-r2con-obfuscated-whitebox-part1/"><meta property="og:title" content="r2-pay: anti-debug, anti-root & anti-frida (part 1) | Romain Thomas"><meta property="og:description" content="This first blog post describes the protections in the challenge r2-pay."><meta property="og:image" content="/post/20-09-r2con-obfuscated-whitebox-part1/featured.png"><meta property="twitter:image" content="/post/20-09-r2con-obfuscated-whitebox-part1/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-09-20T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-20T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/post/20-09-r2con-obfuscated-whitebox-part1/"},"headline":"r2-pay: anti-debug, anti-root \u0026 anti-frida (part 1)","image":["/post/20-09-r2con-obfuscated-whitebox-part1/featured.png"],"datePublished":"2020-09-20T00:00:00Z","dateModified":"2020-09-20T00:00:00Z","author":{"@type":"Person","name":"Romain Thomas"},"publisher":{"@type":"Organization","name":"Romain Thomas","logo":{"@type":"ImageObject","url":"/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_2.png"}},"description":"This first blog post describes the protections in the challenge r2-pay."}</script><title>r2-pay: anti-debug, anti-root & anti-frida (part 1) | Romain Thomas</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Romain Thomas</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Romain Thomas</a></div><div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#projects-images><span>Gallery</span></a></li><li class=nav-item><a class=nav-link href=/#work-experience><span>Work experience</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>r2-pay: anti-debug, anti-root & anti-frida (part 1)</h1><div class=article-metadata><div><span>Romain Thomas</span></div><span class=article-date>Sep 20, 2020</span>
<span class=middot-divider></span><span class=article-reading-time>14 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/categories/android/>Android</a>, <a href=/categories/reverse-engineering/>Reverse Engineering</a></span></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:584px;max-height:1053px><div style=position:relative><img src=/post/20-09-r2con-obfuscated-whitebox-part1/featured.png alt class=featured-image></div></div><div class=article-container><div class=article-style><style>.green{color:green;font-family:fira code,monospace;font-size:87.5%}.blue{color:blue;font-family:fira code,monospace;font-size:87.5%}.orange{color:tomato;font-family:fira code,monospace;font-size:87.5%}.red{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-comment{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-keyword{color:#a90d91;font-family:fira code,monospace;font-size:87.5%}.hl-literal{color:#1c01ce;font-family:fira code,monospace;font-size:87.5%}.hl-preproc{color:#633820;font-family:fira code,monospace;font-size:87.5%}.hl-strings{color:#c41a16;font-family:fira code,monospace;font-size:87.5%}.yellow{color:#cc7000;font-family:fira code,monospace;font-size:87.5%}#</style><h2 id=introduction>Introduction</h2><p>This series of blog posts explains one way to resolve the r2-pay challenge released during the
<a href=https://rada.re/con/2020/ target=_blank rel=noopener>r2con2020</a> conference. This first part is about the
anti-analysis tricks used to hinder reverse-engineering while the second part will be more focused on
breaking the whitebox.</p><p>The resolution took me more than a week-end but it covers nice topics that worth it: <strong>obfuscation & whitebox</strong>.
It was also the opportunity to practice attacks against whiteboxes
and to test
<a href=https://github.com/SideChannelMarvels/JeanGrey target=_blank rel=noopener>SideChannelMarvels/JeanGrey</a> developed by Philippe Teuwen (aka.
<a href=https://twitter.com/doegox target=_blank rel=noopener>@doegox</a>).</p><p>The challenge has been resolved with the AArch64 version on a device running on Android 9 and rooted with Magisk.</p><div class="alert alert-note"><div><p>Here are the files used in this write-up:</p><p><i class="fas fa-mobile-alt"></i> <a href=re.pwnme.1.0.apk>re.pwnme.1.0.apk - af019d3016720592aade7bde9890110c</a></p><p><i class="fas fa-shield-alt"></i> <a href=libnative-lib.so>libnative-lib.so (arm64-v8a version)</a></p></div></div><h2 id=overview>Overview</h2><p>When opening the application on a non-tempered device (or with Magisk hide enabled), we are asked to enter
a PIN and an amount that is used to generate a <em>token</em>.</p><p>To resolve the challenge, we have to find the <em>master key</em> that is used to generate the token.
Few days before the CTF I was told that one of the challenges
would involve an obfuscated whitebox&mldr;</p><p>The main interface of the APK is located in the Java class <code>re.pwnme.MainActivity</code> which forwards the user inputs (PIN & amount)
to a JNI function named <code>gXftm3iswpkVgBNDUp</code>. This function takes the concatenated input $PIN\ ||\ Amount$
and returns the token as a byte array.</p><p>The <strong>static constructor</strong> of the class loads the &ldquo;native-lib&rdquo; library which is available for the architectures:
<code>arm64-v8a</code>, <code>armeabi-v7a</code>, and <code>x86_64</code>. Unsurprisingly, this library is obfuscated and some symbols suggest that it has
been compiled with a fork of O-LLVM <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p><img src=mainactivity_tag.png alt="re.pwnme.MainActivity in r2pay"></p><p>In addition, the library does not export the expected symbol <code>Java_re_pwnme_MainActivity_gXftm3iswpkVgBNDUp</code> but prefers
to use the <code>JNI_OnLoad</code> technique <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. <code>JNI_OnLoad()</code> is also obfuscated along with control-flow-flattening.</p><p>The main task of the challenge is to understand the logic of the <code>gXftm3iswpkVgBNDUp</code> function to figure out how the
<em>token</em> is generated.</p><h2 id=anti-root--anti-frida>Anti-Root & Anti-Frida</h2><p>Along with the <code>libnative-lib.so</code> library, the applications embeds another library <code>libtool-checker.so</code>
whose name sounds quite familiar: it comes from the open-source project
<a href=https://github.com/scottyab/rootbeer target=_blank rel=noopener>rootbeer</a>
which is used to detect if the device is rooted.</p><p>Some of the root-checks are done in the MainActivity class and if the device is rooted the application raises
an exception by dividing a number with 0.</p><p>On this point, we can disable the check by using
<a href=https://frida.re/ target=_blank rel=noopener>Frida</a> on the rootbeer&rsquo;s functions involved in the detection:</p><pre><code>// frida -U -l ./bypass-root.js --no-pause -f re.pwnme
Java.perform(function () {
  var RootCheck = Java.use('\u266b.\u1d64');

  RootCheck['₤'].implementation = function () {
    console.log(&quot;Skip root&quot;);
    return false;
  }

  RootCheck['θ'].overload().implementation = function () {
    console.log(&quot;Skip root&quot;);
    return false;
  }
})
</code></pre><p>Nevertheless, the application still crashes as soon as it starts and generates the following backtrace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>F libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xfa929095 in tid 8875 (re.pwnme), pid 8849 (re.pwnme)
F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
F DEBUG   : Build fingerprint: &#39;google/taimen/taimen:9/PQ3A.190801.002/5670241:user/release-keys&#39;
F DEBUG   : Revision: &#39;rev_10&#39;
F DEBUG   : ABI: &#39;arm64&#39;
F DEBUG   : pid: 8849, tid: 8875, name: re.pwnme  &gt;&gt;&gt; com.google.android.gms &lt;&lt;&lt;
F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xfa929095
F DEBUG   :     x0  0000007f041f6610  x1  0000007f2565c800  x2  0000007f25600000  x3  000000000000001d
F DEBUG   :     x4  000000000000005c  x5  0000000000000001  x6  0000000000000001  x7  0000000000000000
F DEBUG   :     x8  0000007f041f6610  x9  0000007f041f6600  x10 00000000fa929095  x11 00000000000035b2
F DEBUG   :     x12 00000000e34d79ac  x13 00000000fffffff7  x14 00000000a139577d  x15 0000000000000001
F DEBUG   :     x16 0000007fa66af220  x17 0000007fa65e3608  x18 0000000000000000  x19 0000007f041f6680
F DEBUG   :     x20 0000000000000000  x21 0000000000000000  x22 0000229100002291  x23 0000000000000000
F DEBUG   :     x24 0000007f041ff570  x25 0000007f04102000  x26 0000007fab1ad5e0  x27 0000007f0421a690
F DEBUG   :     x28 0000007f04209080  x29 0000007f041ff490
F DEBUG   :     sp  0000007f041f65f0  lr  0000007f0423de04  pc  0000007f0423f980
F DEBUG   :
F DEBUG   : backtrace:
F DEBUG   :     #00 pc 000000000003f980  /data/app/re.pwnme-7O3ynhSmMsg2_E5_uqbQxQ==/lib/arm64/libnative-lib.so
</code></pre></div><p>The backtrace suggests that other checks are performed in the native library. By looking at the ELF&rsquo;s constructors,
we can notice two functions that differ from those generated by the obfuscator:</p><p><img src=elf_ctor.png alt="ELF constructors involved in the detection"></p><div class="alert alert-note"><div><code>.datadiv_decode13003153710004289592</code> functions are in the ELF constructors since they decode global strings that need to be
available as soon as the library is loaded.</div></div><p>By tracing these functions with
<a href=https://qbdi.quarkslab.com/ target=_blank rel=noopener>QBDI</a>, we quickly understand that <span class=green>sub_9080</span> iterates over
<code>/proc/self/maps</code> with the syscalls <span class=blue>openat</span>/<span class=hl-keyword>read</span>
that are located at the addresses <span class=blue>0x009870</span> and <span class=hl-keyword>0x00b448</span>.</p><p>Then, we observe the following sequence:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x011fb0: syscall: openat(0xffffffffffffff9c, &#39;/system/lib64/libc.so&#39;)

0x012884: syscall: read(51, 0x7ffc006c58, 64): &#39;ELF@)@8@&#39;

0x013170: syscall: lseek(51, 0x112918, 0)

0x0145f8: syscall: read(51, 0x7ffc006c18, 64)
0x0145f8: syscall: read(51, 0x7ffc006c18, 64)
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;/ &#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;B88&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;J&gt;&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;RoP)&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;\o((&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;io&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;xo0&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64)
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;Bxx`-&#39;
0x0145f8: syscall: read(51, 0x7ffc006c18, 64): &#39;PP`&#39;

0x0151f4: malloc(0x18): 0x7f0c21f4c0
0x0156e4: syscall: lseek(51, 0x1a650, 0)
0x015a68: malloc(0x1e60): 0x7f0acb2000
0x015fa0: syscall: read(51, 0x7f0acb2000, 0x1e60): &#39;{n@b r@ v@ z@ ~@ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ A A&#34; AB Ab A A A A &#34;A &amp;A&#34; *AB .Ab 2A 6A :A &gt;A BA FA&#34; JAB NAb RA VA ZA ^A bA fA&#34; jAB nAb rA vA zA ~A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A B B&#34; BB Bb B B B B &#34;B &amp;B&#34; *BB .Bb 2B 6B :B &gt;B BB FB&#34; JBB NBb RB VB ZB ^B bB fB&#34; jBB nBb rB vB zB ~B B B&#34; BB Bb B B B B B B&#34; B ...&#39;
0x016cfc: free(0x7f0acb2000) -&gt; {n@b    r@ v@ z@ ~@ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ @ @&#34; @B @b @ @ @ @ A A&#34; AB Ab A A A A &#34;A &amp;A&#34; *AB .Ab 2A 6A :A &gt;A BA FA&#34; JAB NAb RA VA ZA ^A bA fA&#34; jAB nAb rA vA zA ~A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A A A&#34; AB Ab A A A A B B&#34; BB Bb B B B B &#34;B &amp;B&#34; *BB .Bb 2B 6B :B &gt;B BB FB&#34; JBB NBb RB VB ZB ^B bB fB&#34; jBB nBb rB vB zB ~B B B&#34; BB Bb B B B B B B&#34; B ...
0x017118: syscall: close(51)
</code></pre></div><p>From this output, we can infer the following logic:</p><ol><li><code>0x011fb0</code>: the function opens the libc</li><li><code>0x012884</code>: it reads the ELF header</li><li><code>0x013170</code>: it jumps to the ELF sections table</li><li><code>0x0145f8</code>: it looks for the <code>.plt</code> section</li><li><code>0x015a68</code>, <code>0x015fa0</code>: it reads the content of the <code>.plt</code> section</li></ol><p>These operations suggest that the function checks if the <code>.plt</code> of <code>/system/lib64/libc.so</code> is not tampered with.
In particular, if we use Frida on a libc&rsquo;s function this check won&rsquo;t pass.</p><p>After this check, the function <span class=green>sub_9080</span> spawns a thread:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x0195dc: pthread_create(0xf1079f10, 0x0, 0x1a690, 0x0)
</code></pre></div><p>The libc integrity check makes more sense as it is probably used to protect the library against a hook of <code>pthread_create()</code>.</p><p>The thread&rsquo;s routine <span class=red>sub_1a690</span> starts by making two calls to the mathematical function <code>tan()</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x01b774: tan(0.): 0.
0x01b79c: tan(-7832.0): -0.00951489
0x01cc74: memcpy(0x7ffc006598, libnative-lib.so!0x1267f0, 80) -&gt; !7Nl
0x01ceb8: rand()
0x01f774: tan(0.): 0.
0x01f79c: tan(-7832.0): -0.00951489
</code></pre></div><p>My understanding of these calls is that the application tries to protect against tools that would not support
floating-point instructions such as <code>FCMP</code> or <code>FMOV</code>. In addition, I think that if we mock the behavior of
<code>tan()</code> with a constant value it would trigger a crash.</p><p><img src=tan_instruction.png alt=tan></p><p>Then it follows a check of <code>TracerPid</code> value in <code>/proc/self/status</code>. This value is set when
the process is ptrace-debugged (which is the case with gdb).
Dynamically, we observe syscalls that open <code>/proc/self/status</code> and read the content
byte-per-byte:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x020ee0: syscall: openat(0xffffffffffffff9c, &#39;/proc/self/status&#39;): 51
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;N&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;a&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;m&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;e&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;:&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1)
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;r&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;e&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;.&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;p&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;w&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;n&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;m&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;e&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1)
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;S&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;t&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;a&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;t&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;e&#39;
0x0231e8: syscall: read(51, 0x7ffc00656c, 1): &#39;:&#39;
...
</code></pre></div><h2 id=anti-frida-1>Anti-Frida #1</h2><p>Still in the thread&rsquo;s routine <span class=red>sub_1a690</span>, the function checks if Frida is running by looking
at all the values of <code>/proc/self/task/&lt;tid>/status</code> and by checking if one of the names is <span class=red><b><u>gmain</u></b></span>.
It turns out that it&rsquo;s the case when Frida is used in the application :-)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x0368e4: snprintf(&#39;/proc/self/task/9719/status&#39;, &#39;/proc/self/task/%s/status&#39;): &#39;/proc/self/task/9719/status&#39;
0x036a1c: syscall: openat(0xffffffffffffff9c, &#39;/proc/self/task/9719/status&#39;)
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;N&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;a&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;m&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;e&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;:&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1)
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;g&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;m&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;a&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;i&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1): &#39;n&#39;
0x03897c: syscall: read(73, 0x7ffc400af4, 1)
0x03897c: closedir()
# Crash!
</code></pre></div><p>To bypass this check, one can statically patch the syscall or we can dynamically
change the behavior of <code>snprintf(..., '/proc/self/task/%s/status')</code> in order to <strong>always</strong> returns the same status (e.g. <code>/proc/self/task/123/status</code>).
Concretely, it could be done by hooking <code>snprintf</code> and by forcing the <em>output</em> string to <code>/proc/self/task/123/status</code>.</p><h2 id=anti-frida-2>Anti-Frida #2</h2><p>Still in the <span class=red>sub_1a690</span> function, the anti-frida checks continue by inspecting the file descriptors
of the process. It iterates over <code>/proc/self/fd/%s</code> and looks at the underlying symlink.</p><p>Frida <span class=blue>server</span> &mdash; which is running globally on the device &mdash; and Frida agent &mdash; which is injected in the
process &mdash; communicate with named pipes that are associated with a file descriptor.</p><p>If Frida server is running, we can observe the following values:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x04308c: lstat(&#39;/proc/self/fd/32&#39;)
0x043448: syscall: readlinkat(0xffffffffffffff9c, &#39;/proc/self/fd/32&#39;, 0x7ffbffdc10, 256): &#39;anon_inode:[eventfd]&#39;
0x041844: readdir(&#39;33&#39;)
0x043078: snprintf(&#39;/proc/self/fd/33&#39;, &#39;/proc/self/fd/%s&#39;): &#39;/proc/self/fd/33&#39;
0x04308c: lstat(&#39;/proc/self/fd/33&#39;)
0x043448: syscall: readlinkat(0xffffffffffffff9c, &#39;/proc/self/fd/33&#39;, 0x7ffbffdc10, 256): &#39;anon_inode:[eventfd]&#39;

0x041844: readdir(&#39;34&#39;)
0x043078: snprintf(&#39;/proc/self/fd/34&#39;, &#39;/proc/self/fd/%s&#39;): &#39;/proc/self/fd/34&#39;
0x04308c: lstat(&#39;/proc/self/fd/34&#39;)
0x043448: syscall: readlinkat(0xffffffffffffff9c, &#39;/proc/self/fd/34&#39;, 0x7ffbffdc10, 256): &#39;/data/local/tmp/re.frida.server/linjector-500&#39;
# Crash!
</code></pre></div><p>In this case, the file descriptor <code>34</code> is associated with <code>/data/local/tmp/re.frida.server/linjector-500</code>
which triggers the detection and the application crashes.</p><p>As for <code>/proc/self/task/&lt;tid>/status</code>, one can disable this check by <strong>statically patching</strong> the syscalls or
by <strong>dynamically changing</strong> the result of <code>readlinkat()</code>. For instance, we can use
<a href=https://qbdi.quarkslab.com/ target=_blank rel=noopener>QBDI</a> to
instrument syscall instructions and process the result of <code>readlinkat()</code> in an user callback:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>
vm.addMnemonicCB(<span style=color:#e6db74>&#34;SVC&#34;</span>, POST_INST,
  [] (VMInstanceRef vm, GPRState<span style=color:#f92672>*</span> gprState, FPRState<span style=color:#f92672>*</span>, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> data) {
    <span style=color:#66d9ef>if</span> (gprState<span style=color:#f92672>-&gt;</span>x8 <span style=color:#f92672>!=</span> __NR_readlinkat) {
      <span style=color:#66d9ef>return</span> VMAction<span style=color:#f92672>::</span>CONTINUE;
    }

    std<span style=color:#f92672>::</span>string buf <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>*&gt;</span>(gprState<span style=color:#f92672>-&gt;</span>x2);
    <span style=color:#66d9ef>if</span> (buf.find(<span style=color:#e6db74>&#34;re.frida.server&#34;</span>) <span style=color:#f92672>!=</span> std<span style=color:#f92672>::</span>string<span style=color:#f92672>::</span>npos) {
      <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>string FAKE_VALUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;anon_inode:[eventfd]&#34;</span>;
      <span style=color:#75715e>// Bypass Frida detection!
</span><span style=color:#75715e></span>      memcpy(
        <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>*&gt;</span>(gprState<span style=color:#f92672>-&gt;</span>x2),
        <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>*&gt;</span>(FAKE_VALUE.c_str()),
        FAKE_VALUE.size() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
      );
      gprState<span style=color:#f92672>-&gt;</span>x0 <span style=color:#f92672>=</span> FAKE_VALUE.size() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
    }

    <span style=color:#66d9ef>return</span> VMAction<span style=color:#f92672>::</span>CONTINUE;

  }, ctx);

</code></pre></div><h2 id=anti-frida-3->Anti-Frida #3 ?</h2><p>I&rsquo;m not sure if the following calls sequence is used to check the libc&rsquo;s integrity against Frida but
at the end of the thread&rsquo;s routine, we can observe these syscalls:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x048ff0: syscall: openat(0xffffffffffffff9c, &#39;/proc/self/maps&#39;): 51
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;1&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;2&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;c&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;0&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;0&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;0&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;0&#39;
0x04ae6c: syscall: read(51, 0x7ffc006578, 1): &#39;0&#39;
...
0x0513f8: sscanf(&#39;7fa65c0000-7fa65dc000 r-xp 00000000 08:07 1275/system/lib64/libc.so&#39;, &#39;%lx-%lx %s %s %s %s %s&#39;)
0x056034: syscall: close(51)
</code></pre></div><p>The result of <code>sscanf()</code> could be used to check the page permissions (e.g. <code>r</code><span class=blue>w</span><code>xp</code>)
or to the libc&rsquo;s base address (to check if it is consistent).</p><h2 id=anti-root>Anti-Root</h2><p>In addition to the root-beer detection, the library embeds another root detection located in the <strong>second</strong> ELF constructor.
This constructor &mdash; <span class=yellow>sub_77D14</span> &mdash; performs the same early checks as the first constructor
on the libc&rsquo;s <code>.plt</code> integrity before spawning another thread routine, <span class=yellow>sub_98c00</span>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x08861c: pthread_create(0xfa780b70, 0x0, 0x98c00, 0x0)
</code></pre></div><p><img src=ctor_pthread.png alt="ELF constructors: anti-frida and anti-root"></p><p>By tracing the thread&rsquo;s routine, we notice that it checks if <code>su</code> files are present on the device through
three different calls:</p><ol><li>One call to <code>open()</code>: <span class=hl-literal>0x099180: open(<span class=hl-strings>'/system/xbin/su'</span>)</span></li><li>One syscall to <code>openat()</code>: <span class=hl-literal>0x0992a4: syscall: openat(&mldr;, <span class=hl-strings>'/data/su'</span>)</span></li><li>One syscall to <code>faccessat()</code>: <span class=hl-literal>0x0993f0: syscall: faccessat(<span class=hl-strings>'/sbin/su'</span>)</span></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x099180: open(&#39;/data/local/su&#39;): -1
0x0992a4: syscall: openat(0xffffffffffffff9c, &#39;/data/local/su&#39;): -2
0x0993f0: syscall: faccessat(&#39;/data/local/su&#39;): -2
0x099180: open(&#39;/data/local/bin/su&#39;): -1
0x0992a4: syscall: openat(0xffffffffffffff9c, &#39;/data/local/bin/su&#39;): -2
0x0993f0: syscall: faccessat(&#39;/data/local/bin/su&#39;): -2
0x099180: open(&#39;/data/local/xbin/su&#39;): -1
0x0992a4: syscall: openat(0xffffffffffffff9c, &#39;/data/local/xbin/su&#39;): -2
0x0993f0: syscall: faccessat(&#39;/data/local/xbin/su&#39;): -2
0x099180: open(&#39;/sbin/su&#39;): 51
0x0992a4: syscall: openat(0xffffffffffffff9c, &#39;/sbin/su&#39;): 52
0x0993f0: syscall: faccessat(&#39;/sbin/su&#39;): 52
Crash!
</code></pre></div><p>By forcing the results of these functions to <code>-1</code> or <code>-2</code>, we can disable the checks.</p><p>Here is the list of the su-files that are used in this detection:</p><ul><li><span class=hl-strings>/data/local/su</span></li><li><span class=hl-strings>/data/local/bin/su</span></li><li><span class=hl-strings>/data/local/xbin/su</span></li><li><span class=hl-strings>/sbin/su</span></li><li><span class=hl-strings>/su/bin/su</span></li><li><span class=hl-strings>/system/bin/su</span></li><li><span class=hl-strings>/system/bin/.ext/su</span></li><li><span class=hl-strings>/system/bin/failsafe/su</span></li><li><span class=hl-strings>/system/sd/xbin/su</span></li><li><span class=hl-strings>/system/usr/we-need-root/su</span></li><li><span class=hl-strings>/system/xbin/su</span></li><li><span class=hl-strings>/cache/su</span></li><li><span class=hl-strings>/data/su</span></li><li><span class=hl-strings>/dev/su</span></li></ul><p>At the end of the thread&rsquo;s routine, we can also observe the following calls that
are probably used to check if the application is running on a real Android system.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>0x099e30: syscall: faccessat(&#39;/system&#39;)
0x099e30: syscall: faccessat(&#39;/system/bin&#39;)
0x099e30: syscall: faccessat(&#39;/system/sbin&#39;)
0x099e30: syscall: faccessat(&#39;/system/xbin&#39;)
0x099e30: syscall: faccessat(&#39;/vendor/bin&#39;)
0x099e30: syscall: faccessat(&#39;/sbin&#39;)
0x099e30: syscall: faccessat(&#39;/etc&#39;)
</code></pre></div><h2 id=static-bypass-with-lief>Static bypass with LIEF</h2><p>In the previous sections, we described the anti-root, anti-debug and anti-frida checks
made in the ELF constructors. The <strong>same</strong> dynamic checks are also performed in the <code>gXftm3iswpkVgBNDUp</code> function
at the following locations:</p><ul><li><span class=hl-keyword>0x09f2f8</span>: <span class=hl-literal>/proc/self/status</span></li><li><span class=hl-keyword>0x0d4840</span>: <span class=hl-literal>/proc/self/fd/</span></li><li><span class=hl-keyword>0x0dec8c</span>: <span class=hl-literal>/proc/self/task/&lt;tid>/status</span></li></ul><p>While the checks in <code>gXftm3iswpkVgBNDUp</code> can be dynamically disabled when instrumenting the function,
the checks in the ELF constructors are annoying.</p><p>One way to disable the checks in the thread&rsquo;s routines is to disable the <code>pthread_create(...)</code>. It can
be achieved by patching the <code>.plt</code> entry associated with the function:</p><pre><code class=language-armasm data-lang=armasm>mov x0, xzr;
ret;
</code></pre><p>Thanks to <code>llvm-mc</code>, we can get the raw bytes of these instructions:</p><pre><code class=language-console data-lang=console>$ echo &quot;mov x0, xzr;ret;&quot;|llvm-mc -arch=aarch64 -show-encoding

.text
mov     x0, xzr                 // encoding: [0xe0,0x03,0x1f,0xaa]
ret                             // encoding: [0xc0,0x03,0x5f,0xd6]
</code></pre><p>Finally, we can patch the <code>.plt</code> with
<a href=https://lief.quarkslab.com target=_blank rel=noopener>LIEF</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> lief
lib <span style=color:#f92672>=</span> lief<span style=color:#f92672>.</span>parse(<span style=color:#e6db74>&#34;./libnative-lib.so&#34;</span>)
lib<span style=color:#f92672>.</span>patch_address(<span style=color:#ae81ff>0x5870</span>, [<span style=color:#ae81ff>0xe0</span>,<span style=color:#ae81ff>0x03</span>,<span style=color:#ae81ff>0x1f</span>,<span style=color:#ae81ff>0xaa</span>])
lib<span style=color:#f92672>.</span>patch_address(<span style=color:#ae81ff>0x5874</span>, [<span style=color:#ae81ff>0xc0</span>,<span style=color:#ae81ff>0x03</span>,<span style=color:#ae81ff>0x5f</span>,<span style=color:#ae81ff>0xd6</span>])
lib<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;./libnative-lib-patched.so&#34;</span>)
</code></pre></div><p><img src=patching.png alt="pthread_create patches"></p><p>Using these patches and the Frida script exposed in the first section, we are able to <strong>load</strong> the application but the other
detections are triggered in <code>gXftm3iswpkVgBNDUp</code>. Nevertheless, with
the Frida&rsquo;s stalker or QBDI we can trace the instructions and disable the other checks.</p><p>If one wants to completely bypass all the protections statically, here are the patches:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> lief
lib <span style=color:#f92672>=</span> lief<span style=color:#f92672>.</span>parse(<span style=color:#e6db74>&#34;./libnative-lib.so&#34;</span>)

<span style=color:#75715e># Keys are str objects for a better understanding :)</span>
INST <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#34;mov x0, #0&#34;</span>:  [<span style=color:#ae81ff>0xe0</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x1f</span>, <span style=color:#ae81ff>0xaa</span>],
    <span style=color:#e6db74>&#34;ret&#34;</span>:         [<span style=color:#ae81ff>0xc0</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x5f</span>, <span style=color:#ae81ff>0xd6</span>],
    <span style=color:#e6db74>&#34;nop&#34;</span>:         [<span style=color:#ae81ff>0x1f</span>, <span style=color:#ae81ff>0x20</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0xd5</span>],
}

PATCHES <span style=color:#f92672>=</span> [
    <span style=color:#75715e># Patch the .plt entry of pthread_create</span>
    (<span style=color:#ae81ff>0x5870</span>, INST[<span style=color:#e6db74>&#34;mov x0, #0&#34;</span>]),
    (<span style=color:#ae81ff>0x5874</span>, INST[<span style=color:#e6db74>&#34;ret&#34;</span>]),

    <span style=color:#75715e># Disable anti-frida checks</span>
    (<span style=color:#ae81ff>0x0d718c</span>, INST[<span style=color:#e6db74>&#34;mov x0, #0&#34;</span>]), <span style=color:#75715e># /proc/self/fd : patch the result of readlinkat syscall</span>
    (<span style=color:#ae81ff>0x0e1940</span>, INST[<span style=color:#e6db74>&#34;mov x0, #0&#34;</span>]), <span style=color:#75715e># /proc/self/task/&lt;tid&gt;/status: patch the result of read syscall</span>

    <span style=color:#75715e># Disable .text integrity checks</span>
    (<span style=color:#ae81ff>0xB64D0</span>, INST[<span style=color:#e6db74>&#34;nop&#34;</span>]),
]

<span style=color:#66d9ef>for</span> patch <span style=color:#f92672>in</span> PATCHES:
    lib<span style=color:#f92672>.</span>patch_address(<span style=color:#f92672>*</span>patch)

lib<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;libnative-lib.so&#34;</span>)
</code></pre></div><p>When writing this write-up, I realized that patching the syscalls involved in the anti-frida (<span class=hl-literal>/proc/self/fd/</span> and <span class=hl-literal>/proc/self/task/&lt;tid>/status</span>)
makes the application crash.</p><p>It turns out that the library seems to implement <strong>code integrity on the <code>.text</code> section</strong> that I didn&rsquo;t notice when running
the function through QBDI.
Nevertheless, by tracing the basic block<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>
we can identify the basic block involved in the integrity check and patch it.</p><p><img src=code_integrity.png alt="Code integrity patches"></p><div class="alert alert-note"><div>The scripts and the patched library are available <a href=https://github.com/romainthomas/r2pay>here <i class="fab fa-github"></i></a>.</div></div><p>Regarding <code>JNI_OnLoad()</code>, a trace generated with
<a href=https://github.com/QBDI/examples/blob/d589d28b237f46d16cab3b11aa36bbb51102e307/packer-android-x86/src/libshellx_qbdi.cpp#L18-L85 target=_blank rel=noopener>QBDI&rsquo;s ExecBroker</a>
leads to following result:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>JNI_OnLoad() {
    <span style=color:#ae81ff>0x09af3c</span><span style=color:#f92672>:</span> GetEnv(<span style=color:#ae81ff>0x7fcb507460</span>, <span style=color:#ae81ff>0x10006</span>)
    <span style=color:#ae81ff>0x09b0ac</span><span style=color:#f92672>:</span> FindClass(<span style=color:#e6db74>&#34;re/pwnme/MainActivity&#34;</span>)<span style=color:#f92672>:</span> <span style=color:#ae81ff>537</span>
    <span style=color:#ae81ff>0x09b1b4</span><span style=color:#f92672>:</span> RegisterNatives()
        gXftm3iswpkVgBNDUp ([BB)[B <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;libnative-lib.so@0x9b41c&#34;</span>
}
</code></pre></div><p>Then, we can extract the function&rsquo;s offset: <span class=blue>gXftm3iswpkVgBNDUp</span>: <span class=red>0x9b41c</span>.</p><h2 id=summary--conclusion>Summary & Conclusion</h2><p>Whilst Frida detections are usually based on sockets and library names in <code>/proc/self/maps</code>,
this challenge introduces two detections based on named pipes:<code>/proc/self/fd</code> and thread status: <code>/proc/self/task/&lt;tid>/status</code>
which are pretty cool :-)</p><p>These checks are performed in two locations:</p><ol><li>The ELF constructors</li><li>The function <code>gXftm3iswpkVgBNDUp()</code></li></ol><p>The implementation in the ELF constructors might be tricky to analyse since the functions are called before <strong>any</strong>
other classical functions (which includes <code>JNI_OnLoad()</code>). Nevertheless, thanks to the interface of the ELF loader,
it exposes the function <code>call_array(...)</code><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> which is handy to process the ELF constructors.</p><div class="alert alert-note"><div>This function is mangled as <code>__dl__ZL10call_arrayIPFviPPcS1_EEvPKcPT_mbS5_</code> in <code>/system/bin/linker64</code></div></div><p><img src=protection_overview.png alt="Overview of the anti-root and anti-frida"></p><p>Since QBDI is not detected in this challenge, it&rsquo;s a good opportunity to give it a try:</p><center><i class="fab fa-github"></i> <a href=https://github.com/QBDI/QBDI>https://github.com/QBDI/QBDI</a></center><h2 id=acknowledgments>Acknowledgments</h2><p>Thanks to <u>Eduardo Novella</u> (
<a href=https://twitter.com/enovella_ target=_blank rel=noopener>@enovella_</a>)
and <u>Gautam Arvind</u> (
<a href=https://twitter.com/darvincisec target=_blank rel=noopener>@darvincisec</a>) for this interesting and realistic challenge they created!</p><p>Also thanks to <u><a href=https://www.quarkslab.com target=_blank rel=noopener>Quarkslab</a></u> that allowed this publication.
For those who are interested in similar topics, you can take a look at the Quarkslab&rsquo;s
<a href=https://blog.quarkslab.com/ target=_blank rel=noopener>blog</a>.</p><h3 id=references>References</h3><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://github.com/GoSSIP-SJTU/Armariris target=_blank rel=noopener>GoSSIP-SJTU/Armariris</a> -
<a href=https://github.com/GoSSIP-SJTU/Armariris/blob/0cba41329244a29c7cb94e25458191b68967b6e8/lib/Transforms/Obfuscation/StringObfuscation.cpp#L140 target=_blank rel=noopener><code>StringObfuscation.cpp#L140</code></a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://developer.android.com/training/articles/perf-jni#native-libraries>https://developer.android.com/training/articles/perf-jni#native-libraries</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://github.com/QBDI/QBDI/blob/a20653f07df3ae78250e7ecf28ed699b2d727027/include/QBDI/VM.h#L296-L305 target=_blank rel=noopener><code>addVMEventCB(VMEvent::BASIC_BLOCK_ENTRY, ...);</code></a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://android.googlesource.com/platform/bionic/+/refs/tags/android-9.0.0_r60/linker/linker_soinfo.cpp#420 target=_blank rel=noopener><code>linker/linker_soinfo.cpp:420</code></a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=article-tags><a class="badge badge-light" href=/tags/android/>android</a>
<a class="badge badge-light" href=/tags/reverse-engineering/>reverse engineering</a>
<a class="badge badge-light" href=/tags/write-up/>write-up</a>
<a class="badge badge-light" href=/tags/obfuscation/>obfuscation</a>
<a class="badge badge-light" href=/tags/whitebox/>whitebox</a></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/armasm.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.f6ecf7692215f2bc4850b72c8176bfa2.js></script><div class=container><footer class=site-footer><p class=powered-by>Published with <a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic Website Builder</a> - Icons made by <a href=http://www.freepik.com/ title=Freepik>Freepik</a></p><p class=powered-by><span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>