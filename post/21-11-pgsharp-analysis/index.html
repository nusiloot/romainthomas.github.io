<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=generator content="Source Themes Academic 4.8.0">
<meta name=description content="This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO.">
<link rel=alternate hreflang=en-us href=https://www.romainthomas.fr/post/21-11-pgsharp-analysis/>
<meta name=theme-color content="#2962ff">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-light>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/atom-one-light.min.css crossorigin=anonymous title=hl-dark disabled>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous>
<script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono%7CFira+Code&display=swap">
<link rel=stylesheet href=/css/academic.css>
<link href=https://www.romainthomas.fr/post/index.xml rel=feed type=application/rss+xml title="Blog Posts | Romain Thomas">
<link href=https://www.romainthomas.fr/post/index.xml rel=alternate type=application/rss+xml title="Blog Posts | Romain Thomas">
<link rel=manifest href=/index.webmanifest>
<link rel=icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_32x32_fill_lanczos_center_3.png>
<link rel=apple-touch-icon type=image/png href=/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_3.png>
<link rel=canonical href=https://www.romainthomas.fr/post/21-11-pgsharp-analysis/>
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:site" content="@rh0main">
<meta property="twitter:creator" content="@rh0main">
<meta property="og:site_name" content="Romain Thomas">
<meta property="og:url" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/">
<meta property="og:title" content="PGSharp: Analysis of a Cheating App for PokemonGO | Romain Thomas">
<meta property="og:description" content="This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO."><meta property="og:image" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/featured.png">
<meta property="twitter:image" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/featured.png"><meta property="og:locale" content="en-us">
<meta property="article:published_time" content="2021-11-07T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-07T00:00:00+00:00">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.romainthomas.fr/post/21-11-pgsharp-analysis/"},"headline":"PGSharp: Analysis of a Cheating App for PokemonGO","image":["https://www.romainthomas.fr/post/21-11-pgsharp-analysis/featured.png"],"datePublished":"2021-11-07T00:00:00Z","dateModified":"2021-11-07T00:00:00Z","author":{"@type":"Person","name":"Romain Thomas"},"publisher":{"@type":"Organization","name":"Romain Thomas","logo":{"@type":"ImageObject","url":"https://www.romainthomas.fr/images/icon_hu2654a0fcc87c65a864822ac27b001d3b_698_192x192_fill_lanczos_center_3.png"}},"description":"This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO."}</script>
<title>PGSharp: Analysis of a Cheating App for PokemonGO | Romain Thomas</title>
</head>
<body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents>
<aside class=search-results id=search>
<div class=container>
<section class=search-header>
<div class="row no-gutters justify-content-between mb-3">
<div class=col-6>
<h1>Search</h1>
</div>
<div class="col-6 col-search-close">
<a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a>
</div>
</div>
<div id=search-box>
<input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control>
</div>
</section>
<section class=section-search-results>
<div id=search-hits>
</div>
</section>
</div>
</aside>
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
<div class=container>
<div class="d-none d-lg-inline-flex">
<a class=navbar-brand href=/>Romain Thomas</a>
</div>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span>
</button>
<div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
<a class=navbar-brand href=/>Romain Thomas</a>
</div>
<div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content>
<ul class="navbar-nav d-md-inline-flex">
<li class=nav-item>
<a class=nav-link href=/#about><span>Home</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#publications><span>Publications</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#posts><span>Posts</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#projects><span>Projects</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#projects-images><span>Gallery</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#work-experience><span>Work experience</span></a>
</li>
<li class=nav-item>
<a class=nav-link href=/#contact><span>Contact</span></a>
</li>
</ul>
</div>
<ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
<li class=nav-item>
<a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a>
</li>
</ul>
</div>
</nav>
<article class=article>
<div class="article-container pt-3">
<h1>PGSharp: Analysis of a Cheating App for PokemonGO</h1>
<div class=article-metadata>
<div>
<span>Romain Thomas</span>
</div>
<span class=article-date>
Nov 7, 2021
</span>
<span class=middot-divider></span>
<span class=article-reading-time>
25 min read
</span>
<span class=middot-divider></span>
<span class=article-categories>
<i class="fas fa-folder mr-1"></i><a href=/categories/android/>Android</a>, <a href=/categories/reverse-engineering/>Reverse Engineering</a></span>
</div>
</div>
<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:410px>
<div style=position:relative>
<img src=/post/21-11-pgsharp-analysis/featured_huad1debbc566b2d212823c16682254604_674887_720x0_resize_lanczos_3.png alt class=featured-image>
</div>
</div>
<div class=article-container>
<div class=article-style>
<style>.green{color:green;font-family:fira code,monospace;font-size:87.5%}.blue{color:blue;font-family:fira code,monospace;font-size:87.5%}.orange{color:tomato;font-family:fira code,monospace;font-size:87.5%}.red{color:#c02032;font-family:fira code,monospace;font-size:87.5%}a.ul{color:#c02032}.hl-comment{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-keyword{color:#a90d91;font-family:fira code,monospace;font-size:87.5%}.hl-literal{color:#1c01ce;font-family:fira code,monospace;font-size:87.5%}.hl-preproc{color:#633820;font-family:fira code,monospace;font-size:87.5%}.hl-strings{color:#c41a16;font-family:fira code,monospace;font-size:87.5%}.yellow{color:#cc7000;font-family:fira code,monospace;font-size:87.5%}.article-container{max-width:900px}</style>
<h2 id=introduction>Introduction</h2>
<p>A few days after the release of the blog post
<a href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/><em>Gotta Catch &lsquo;Em All: Frida & jailbreak detection</em></a>, someone on
<a href=https://www.reddit.com/r/ReverseEngineering/comments/on6ya9/comment/h5rhkoc/ target=_blank rel=noopener>reddit - r/ReverseEngineering</a>
caught my attention on a cheating app for the Android version of PokemonGO:</p>
<p><img src=reddit.png alt="reddit comment about PGSharp"></p>
<p>So here it is!</p>
<p>PGSharp belongs to the family of PokemonGO&rsquo;s cheating app that is not (yet) banned by Niantic.
This cheat provides an <em>enhanced</em> game experience with interesting functionalities such as:</p>
<ul>
<li>GPS Spoofing</li>
<li>Quick Catch</li>
<li>Pokemon Feed</li>
<li>Nearby Radar</li>
<li>&mldr;</li>
</ul>
<p>Last but not least, PGSharp runs on regular devices, <strong>rooted or not</strong>.</p>
<p>This cheat made my weekends for the last 4 months and, from a technical point of view, it was worth it.
As will be discussed through this blog post, PGSharp uses several interesting tricks.</p>
<div class="alert alert-note">
<div>
<p>The content of this blog post is based on <strong>PGSharp 1.33.0</strong> which is related to the following APKs:</p>
<p><i class="fas fa-gamepad"></i> <a href=https://data.romainthomas.fr/21-09-pgsharp/pgs1.33.0.apk>PGSharp v1.33.0</a></p>
<p><i class="fas fa-gamepad"></i> <a href=https://data.romainthomas.fr/21-09-pgsharp/com.nianticlabs.pokemongo_0.221.0-2021093001.apk>PokemonGO v0.221.0</a></p>
</div>
</div>
<p>This blog post is quite <strong>long</strong> but the different parts are
more or less independents, so feel free to jump on them depending on your interests:</p>
<p><span id=toc></span></p>
<ul>
<li>
<a href=#code-protection><i class="fas fa-shield-alt"></i>  Code Protection</a>
<ul>
<li>
<a href=#lua-vm>Lua VM</a></li>
<li>
<a href=#java-obfuscation>Java Obfuscation</a></li>
</ul>
</li>
<li>
<a href=#cheat-mechanisms><i class="fas fa-cogs"></i>  Cheat Mechanisms</a>
<ul>
<li>
<a href=#dex-files-diff>DEX Files Comparison</a></li>
<li>
<a href=#libmain>libmain.so</a></li>
<li>
<a href=#signature-bypass>Signature Bypass</a></li>
<li>
<a href=#dynamic-apk-loading>Dynamic APK Loading</a></li>
<li>
<a href=#gps-spoofing>GPS Spoofing</a></li>
<li>
<a href=#jnienv-proxifier>JNIEnv Proxifier</a></li>
<li>
<a href=#unity-hooks>Unity Hooks</a></li>
<li>
<a href=#network>Network Communications</a></li>
<li>
<a href=#safetynet>SafetyNet</a></li>
<li>
<a href=#pgsharp-signature-check>When PGSharp avoids PokemonGO pitfalls</a></li>
</ul>
</li>
<li>
<a href=#final-words><i class="fas fa-power-off"></i>  Final Words</a></li>
<li>
<a href=#acknowledgments><i class="fas fa-stream"></i>  Acknowledgments</a></li>
<li>
<a href=#annexes><i class="fas fa-clipboard"></i>  Annexes</a></li>
</ul>
<p>You can also check the slides to get an overview of the content:</p>
<div class="pdfpreview shortcode shortcode--pdfpreview">
<embed src=/publication/21-ekoparty-mobile-hacking-space-pgsharp/21-10-ekoparty-mobile-hacking-space-pgsharp.pdf type=application/pdf width=100% height=450px>
</div>
<center>
<br><br>
<b>Enjoy!</b>
</center>
<h2 id=code-protection>
<a href=#toc><i class="fas fa-angle-up"></i>  Code Protection</a></h2>
<p>PokemonGO is a target of choice for reverse engineers and some critical functionalities are protected by a commercial solution.
It is worth mentioning that only a subset of the game is obfuscated. For instance, the &ldquo;Java&rdquo; part of the
game is absolutely not protected, such as we have the original class and method names.
The Unity part is &ldquo;compiled&rdquo; into <code>libil2cpp.so</code> but we can recover some metadata with
<a href=https://github.com/Perfare/Il2CppDumper target=_blank rel=noopener>Perfare/Il2CppDumper</a>.</p>
<p>All the obfuscation is focused on <code>libNianticLabsPlugin.so</code> (c.f.
<a href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/><em>Gotta Catch &lsquo;Em All: Frida & jailbreak detection</em></a>),
and since only this part of the game is heavily obfuscated, it gives a hint about where the critical functionalities are.</p>
<p>On the other hand, PGSharp uses different layers of obfuscation to prevent its analysis.
First of all, it uses O-LLVM to obfuscate the native code that includes, at least, control-flow flattening and
string encryption. Nevertheless, the obfuscation is <em>relatively</em> weak against emulation and static analysis<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p>
<h3 id=lua-vm>
<a href=#toc><i class="fas fa-angle-up"></i>  Lua VM</a></h3>
<p>Some obfuscation techniques are based on transforming the original code through a VM (like
<a href=https://vmpsoft.com/ target=_blank rel=noopener>VMProtect</a>).
It adds another layer to reverse, as we need to understand the VM architecture before being able to understand the original semantic of the code.</p>
<center>
<b>
But what about using an interpreted language (like Python) and obfuscate its VM or its interpreter with O-LLVM?
</b><br>
</center>
<p>This is what PGSharp does with Lua. Some parts of the cheat are written in Lua whose the VM has been modified to:</p>
<ol>
<li>Fake the version: try to make believe <code>Lua 5.1</code> while it&rsquo;s <code>Lua 5.3</code></li>
<li>Add new opcodes (<code>OP_RUN</code>, <code>OP_GETDOWNVAL</code>, <code>OP_OLDTABLE</code>, and <code>OP_XXOR</code>) to break decompilation and
common Lua tools.</li>
</ol>
<p>The native library that implements the cheat functionalities and that contains the Lua VM being stripped, one of the
challenges lies in recognizing the Lua C API among the library&rsquo;s functions<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. For instance,
here is a basic block of a native function that uses the Lua API:</p>
<p><img src=lua_func_re.png alt="Stripped PGSharp function"></p>
<p>Among all the Lua C functions, some of them are worth identifying to ease reverse engineering:</p>
<ul>
<li>
<dl>
<dt><code>luaL_loadbuffer</code></dt>
<dd><blockquote>
<p><em>&ldquo;Load a buffer as a Lua chunk."</em>.</p>
</blockquote>
</dd>
<dd>
<p>Basically, it loads a Lua bytecode from a buffer given in parameter.
This Lua bytecode is the result of the <em>compilation</em> of the original script with
<a href=https://www.lua.org/manual/5.3/luac.html target=_blank rel=noopener>luac</a>.
By hooking this function, we can recover the following files:</p>
<ul>
<li><span class=orange>base64.luac</span></li>
<li><span class=green>class.luac</span></li>
<li><span class=green>global.luac</span></li>
<li><span class=green>init.luac</span></li>
<li><span class=orange>json.luac - from
<a href=https://github.com/rxi/json.lua target=_blank rel=noopener>https://github.com/rxi/json.lua</a></span></li>
<li><span class=green>location.luac</span></li>
<li><span class=orange>md5.luac - from
<a href=https://github.com/kikito/md5.lua target=_blank rel=noopener>https://github.com/kikito/md5.lua</a></span></li>
<li><span class=green>pgo.luac</span></li>
<li><span class=green>pgodump.luac</span></li>
<li><span class=green>plugin.luac</span></li>
<li><span class=green>reflect.luac</span></li>
</ul>
</dd>
</dl>
<p>The <span class=orange>orange files</span> are utilities, while the <span class=green>green ones</span>
contain cheat mechanisms.</p>
</li>
<li>
<dl>
<dt><code>luaD_precall</code></dt>
<dd>Function that is involved when calling a C native function or a pure Lua function.
Since its prototype is <span class=blue>(lua_State *L, StkId func, int nresults)</span>,
it can help to dynamically identify which function is called:</dd>
</dl>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>0x6776a8 luaD_precall(&#39;gamehelper&#39;)
0x6776a8 luaD_precall(&#39;@./app/arm64-v8a/luac/global.lua:0 - sub_71733ea5d0&#39;) {
0x694d90 luaD_precall(&#39;@./app/arm64-v8a/luac/global.lua:246 - sub_71733f7b50&#39;) {
0x6776a8 luaD_precall(&#39;@./app/arm64-v8a/luac/location.lua:38 - sub_717346d650&#39;) {
</code></pre></div></li>
<li>
<dl>
<dt><code>lua_pushcclosure</code></dt>
<dd><blockquote>
<p>Pushes a new C closure onto the stack.</p>
</blockquote>
</dd>
<dd>
<p>This function is particularly interesting to recover
native C functions linked to Lua function:</p>
</dd>
</dl>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>0x0e9cc0: lua_pushcclosure(&#39;initil2cppmethods&#39;)
0x0e9cd4: lua_setfield(-2, &#39;initil2cppmethods&#39;, &#39;func_0xedaa0&#39;)
...
0x0e9d10: lua_pushcclosure(&#39;nar&#39;)
0x0e9d24: lua_setfield(-2, &#39;nar&#39;, &#39;func_0xeddbc&#39;)
...
0x0ea020: lua_pushcclosure(&#39;ipf&#39;)
0x0ea034: lua_setfield(-2, &#39;ipf&#39;, &#39;func_0x1318b0&#39;)
</code></pre></div></li>
<li>
<dl>
<dt><code>lua_pushstring</code></dt>
<dd><blockquote>
<p><em>&ldquo;Pushes the zero-terminated string pointed to by s onto the stack."</em></p>
</blockquote>
</dd>
<dd>
<p>This function enables to dynamically recover strings that might not be present
in the native code or somehow encoded:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>0x0ebdfc: lua_pushstring(&#39;https://tens.pgsharp.com/v1/scc-2-[...]/&#39;)
0x0ebe28: lua_pushstring(&#39;me.uw.hela.pref&#39;)
0x0c56ac: lua_pushstring(&#39;AIza[...]XhM4&#39;)
0x0e15b4: lua_pushstring(&#39;token=[Redacted]&#39;)
</code></pre></div></dd>
</dl>
</li>
</ul>
<div class="alert alert-">
<div>
<p>To dynamically understand the behavior of the Lua VM, we can compile the Frida Gum SDK along with Lua v5.3.</p>
<p>It enables to hook Lua functions with Frida and to leverage the compiled Lua v5.3 to inspect the parameters:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>extern</span> <span class=s>&#34;C&#34;</span> <span class=p>{</span>
<span class=cp>#include</span> <span class=cpf>&#34;lua.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;ldo.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;ldebug.h&#34;</span><span class=cp>
</span><span class=cp></span><span class=p>}</span>

<span class=n>gum_interceptor_attach</span><span class=p>(</span><span class=n>listener_</span><span class=o>-&gt;</span><span class=n>interceptor</span><span class=p>,</span>
                       <span class=n>luaD_precall_addr</span><span class=p>,</span> <span class=n>listener_</span> <span class=n>luaD_precall_addr</span><span class=p>);</span>

<span class=kt>void</span> <span class=nf>native_listener_on_enter</span><span class=p>(</span><span class=n>GumInvocationListener</span> <span class=o>*</span><span class=n>listener</span><span class=p>,</span> <span class=n>GumInvocationContext</span><span class=o>*</span> <span class=n>ic</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>auto</span><span class=o>*</span> <span class=n>L</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>lua_State</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>ic</span><span class=o>-&gt;</span><span class=n>cpu_context</span><span class=o>-&gt;</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
  <span class=k>auto</span> <span class=n>func</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>StkId</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ic</span><span class=o>-&gt;</span><span class=n>cpu_context</span><span class=o>-&gt;</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
  <span class=k>auto</span> <span class=n>narg</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ic</span><span class=o>-&gt;</span><span class=n>cpu_context</span><span class=o>-&gt;</span><span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>ttype</span><span class=p>(</span><span class=n>func</span><span class=p>)</span> <span class=o>!=</span> <span class=n>LUA_TLCL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>log</span><span class=p>(</span><span class=s>&#34;sub_{:x}&#34;</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>Proto</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>clLvalue</span><span class=p>(</span><span class=n>func</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>log</span><span class=p>(</span><span class=s>&#34;{}:{:d} - sub_{:x}&#34;</span><span class=p>,</span> <span class=n>getstr</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>source</span><span class=p>),</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>linedefined</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div>
</div>
</div>
<h3 id=java-obfuscation>
<a href=#toc><i class="fas fa-angle-up"></i>  Java Obfuscation</a></h3>
<p>Contrary to the PokemonGO&rsquo;s Java layer, PGSharp protects its Java code with Proguard and the strings are xored
with the hardcoded key:</p>
<center>
<b class=orange>vqGqQWCVnDRrNXTR</b><br><br>
</center>
<p>This key seems to not change across the different versions of PGSharp and the encoded strings look
like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>q</span><span class=o>()</span> <span class=o>{</span>
  <span class=n>String</span> <span class=n>a</span> <span class=o>=</span> <span class=n>GL</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;FAQgLiQlLw==&#34;</span><span class=o>),</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=kc>null</span><span class=o>);</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>JSONObject</span> <span class=n>jSONObject</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JSONObject</span><span class=o>();</span>
    <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>GL</span><span class=o>.</span><span class=na>c</span><span class=o>;</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;Agg3FA==&#34;</span><span class=o>),</span> <span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;Axg=&#34;</span><span class=o>));</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;Axgj&#34;</span><span class=o>),</span> <span class=n>UI</span><span class=o>.</span><span class=na>g</span><span class=o>(</span><span class=n>context</span><span class=o>));</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;BQUmBTQ=&#34;</span><span class=o>),</span> <span class=k>this</span><span class=o>.</span><span class=na>s</span><span class=o>);</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;BQEoHjc+LTE=&#34;</span><span class=o>),</span> <span class=o>((</span><span class=n>Boolean</span><span class=o>)</span> <span class=o>...);</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;BAUr&#34;</span><span class=o>),</span> <span class=n>UI</span><span class=o>.</span><span class=na>f</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;Gh8g&#34;</span><span class=o>),</span> <span class=n>Locale</span><span class=o>.</span><span class=na>getDefault</span><span class=o>().</span><span class=na>getDisplayLanguage</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;FxMu&#34;</span><span class=o>),</span> <span class=n>UI</span><span class=o>.</span><span class=na>a</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;FBA1&#34;</span><span class=o>),</span> <span class=n>LayoutInflater$Factory2o</span><span class=o>.</span><span class=na>i</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>context</span><span class=o>));</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>r3</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;Gx4j&#34;</span><span class=o>),</span> <span class=n>Build</span><span class=o>.</span><span class=na>MODEL</span><span class=o>);</span>
    <span class=n>String</span> <span class=n>str</span> <span class=o>=</span> <span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>RELEASE</span><span class=o>;</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>The string encoding routine being easy to reverse, we can create a Jadx plugin
that automatically decodes these strings:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=o>[...]</span>
<span class=n>passes</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>SimplifyVisitor</span><span class=o>());</span>

<span class=n>passes</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>PGSharpString</span><span class=o>());</span> <span class=c1>// Automatically decode the strings
</span><span class=c1></span>
<span class=n>passes</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>CheckRegions</span><span class=o>());</span>
<span class=o>[...]</span>
</code></pre></div><p>It results in this kind of output:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>q</span><span class=o>()</span> <span class=o>{</span>
  <span class=n>String</span> <span class=n>a</span> <span class=o>=</span> <span class=n>GL</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;bug_url&#34;</span><span class=o>,</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=kc>null</span><span class=o>);</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>JSONObject</span> <span class=n>jSONObject</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JSONObject</span><span class=o>();</span>
    <span class=n>Context</span> <span class=n>context</span> <span class=o>=</span> <span class=n>GL</span><span class=o>.</span><span class=na>c</span><span class=o>;</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;type&#34;</span><span class=o>,</span> <span class=s>&#34;ui&#34;</span><span class=o>);</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;uid&#34;</span><span class=o>,</span> <span class=n>UI</span><span class=o>.</span><span class=na>g</span><span class=o>(</span><span class=n>context</span><span class=o>));</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;state&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>s</span><span class=o>);</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;spoofing&#34;</span><span class=o>,</span> <span class=o>((</span><span class=n>Boolean</span><span class=o>)</span> <span class=n>PL</span><span class=o>.</span><span class=na>a</span><span class=o>(</span><span class=s>&#34;hlspoofing&#34;</span><span class=o>)).</span><span class=na>booleanValue</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;rtl&#34;</span><span class=o>,</span> <span class=n>UI</span><span class=o>.</span><span class=na>f</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;lng&#34;</span><span class=o>,</span> <span class=n>Locale</span><span class=o>.</span><span class=na>getDefault</span><span class=o>().</span><span class=na>getDisplayLanguage</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;abi&#34;</span><span class=o>,</span> <span class=n>UI</span><span class=o>.</span><span class=na>a</span><span class=o>());</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;bar&#34;</span><span class=o>,</span> <span class=n>LayoutInflater$Factory2o</span><span class=o>.</span><span class=na>i</span><span class=o>.</span><span class=na>e</span><span class=o>(</span><span class=n>context</span><span class=o>));</span>
    <span class=n>jSONObject</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;mod&#34;</span><span class=o>,</span> <span class=n>Build</span><span class=o>.</span><span class=na>MODEL</span><span class=o>);</span>
    <span class=n>String</span> <span class=n>str</span> <span class=o>=</span> <span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>RELEASE</span><span class=o>;</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>You can find the whole Jadx <em>plugin</em> on Github:
<a href=https://github.com/romainthomas/pgsharp/blob/9addafbb6672571d2b7fbba43899f662c21aac8e/jadx/PGSharpStrings.java target=_blank rel=noopener>PGSharpStrings.java</a></p>
<hr width=50%>
<h2 id=cheat-mechanisms>
<a href=#toc><i class="fas fa-angle-up"></i>  Cheat Mechanisms</a></h2>
<p>One <del>disruptive</del> feature of PGSharp is that it does not require a rooted device. Until recently,
most of the PokemonGO cheating apps required a jailbroken or a rooted device which raises a barrier
for people who are not familiar with rooting.</p>
<blockquote>
<p>But wait, how <em>hell</em> they do that?</p>
</blockquote>
<p>The structure of the PGSharp APK is <strong>very</strong> close to the genuine PokemonGO
application, which leads identifying which parts of the game have been tampered with.</p>
<p>A naive comparison (cf.
<a href=https://github.com/romainthomas/pgsharp/blob/9addafbb6672571d2b7fbba43899f662c21aac8e/zip_diff.py target=_blank rel=noopener>zip_diff.py</a>) raises mismatches on the following files:</p>
<table>
<thead>
<tr>
<th style=text-align:left>File</th>
<th style=text-align:left>Size in PGSharp</th>
<th style=text-align:left>Size in PGO</th>
<th style=text-align:left>Delta</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>classes.dex</td>
<td style=text-align:left>9057844</td>
<td style=text-align:left>8953000</td>
<td style=text-align:left>+1.17%</td>
</tr>
<tr>
<td style=text-align:left>classes2.dex</td>
<td style=text-align:left>7131864</td>
<td style=text-align:left>7107296</td>
<td style=text-align:left>+0.34%</td>
</tr>
<tr>
<td style=text-align:left>lib/arm64-v8a/libmain.so</td>
<td style=text-align:left>21278480</td>
<td style=text-align:left>6424</td>
<td style=text-align:left>+331134%</td>
</tr>
<tr>
<td style=text-align:left>META-INF/MANIFEST.MF</td>
<td style=text-align:left>351045</td>
<td style=text-align:left>355533</td>
<td style=text-align:left>-1.26%</td>
</tr>
</tbody>
</table>
<p>The high level of similarity between the two applications, associated with a different signature
confirms that PGSharp repackaged the original application.</p>
<h4 id=dex-files-diff>
<a href=#toc><i class="fas fa-angle-up"></i>  DEX Files Comparison</a></h4>
<p>To figure out which parts of the DEX files have been modified, we can use LIEF (yes, LIEF can <u><b>read</b></u> the DEX format).
Basically, the idea is to check which method(s) has a bytecode whose the size is different from the real PokemonGO
application:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>zipfile</span>
<span class=kn>import</span> <span class=nn>lief</span>

<span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>CHEAT_FILE</span><span class=p>)</span> <span class=k>as</span> <span class=n>zip_file</span><span class=p>:</span>
    <span class=k>with</span> <span class=n>zip_file</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>target</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=n>hela_dex</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>


<span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>ORIG_FILE</span><span class=p>)</span> <span class=k>as</span> <span class=n>zip_file</span><span class=p>:</span>
    <span class=k>with</span> <span class=n>zip_file</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>target</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=n>pgo_dex</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

<span class=n>hela_dex</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>DEX</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>hela_dex</span><span class=p>))</span>
<span class=n>pgo_dex</span>  <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>DEX</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>pgo_dex</span><span class=p>))</span>

<span class=n>hela</span> <span class=o>=</span> <span class=p>{</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>cls</span><span class=o>.</span><span class=n>pretty_name</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>prototype</span><span class=si>!s}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>bytecode</span><span class=p>)</span> \
          <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>hela_dex</span><span class=o>.</span><span class=n>methods</span><span class=p>}</span>

<span class=n>pgo</span>  <span class=o>=</span> <span class=p>{</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>cls</span><span class=o>.</span><span class=n>pretty_name</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>prototype</span><span class=si>!s}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>bytecode</span><span class=p>)</span> \
          <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>pgo_dex</span><span class=o>.</span><span class=n>methods</span><span class=p>}</span>

<span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>size_hela</span> <span class=ow>in</span> <span class=n>hela</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
    <span class=n>size_pgo</span> <span class=o>=</span> <span class=n>pgo</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
    <span class=k>if</span> <span class=n>size_pgo</span> <span class=o>!=</span> <span class=n>size_hela</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Mismatch: </span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></div><p>By running this script on <code>classes.dex</code>, we don&rsquo;t find any difference.
Actually, the PGSharp authors tried to prevent <em>diffing</em> by changing the line number attribute of the DEX classes.
If we try to diff the two applications from the output of apktool or Jadx, we get a lot of noise as the line number is
used in the output. On the other hand, the size bytecode for this kind of repackaging is suitable<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p>
<p>Running the same script on <code>classes2.dex</code> raises the following mismatches:</p>
<ul>
<li><code>holoholo.libholoholo.unity.UnityMainActivity.onActivityResult</code></li>
<li><code>holoholo.nativelib.Library.&lt;clinit></code></li>
</ul>
<p>In <code>UnityMainActivity.onActivityResult</code>, they changed this piece of code:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onActivityResult</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>,</span> <span class=kt>int</span> <span class=n>i2</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>UnityCallbackInfo</span> <span class=n>unityCallbackInfo</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>activityCallbacks</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>unityCallbackInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>UnityPlayer</span><span class=o>.</span><span class=na>UnitySendMessage</span><span class=o>(</span><span class=n>unityCallbackInfo</span><span class=o>.</span><span class=na>mGameObjectName</span><span class=o>,</span>
                                 <span class=n>unityCallbackInfo</span><span class=o>.</span><span class=na>mMethodName</span><span class=o>,</span>
                                 <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i2</span><span class=o>));</span>
  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
    <span class=n>Client</span><span class=o>.</span><span class=na>handleActivityResult</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>intent</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>into:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onActivityResult</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>,</span> <span class=kt>int</span> <span class=n>i2</span><span class=o>,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>UnityCallbackInfo</span> <span class=n>unityCallbackInfo</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>activityCallbacks</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>unityCallbackInfo</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>String</span> <span class=n>mGameObjectName</span> <span class=o>=</span> <span class=n>unityCallbackInfo</span><span class=o>.</span><span class=na>mGameObjectName</span><span class=o>;</span>
      <span class=n>UnityPlayer</span><span class=o>.</span><span class=na>UnitySendMessage</span><span class=o>(</span><span class=n>mGameObjectName</span><span class=o>,</span> <span class=n>unityCallbackInfo</span><span class=o>.</span><span class=na>mMethodName</span><span class=o>,</span> <span class=s>&#34;HL.PL&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>mGameObjectName</span><span class=o>)</span> <span class=o>?</span> <span class=n>intent</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=s>&#34;&#34;</span> <span class=o>:</span> <span class=n>intent</span><span class=o>.</span><span class=na>getData</span><span class=o>().</span><span class=na>toString</span><span class=o>()</span> <span class=o>:</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i2</span><span class=o>));</span>
      <span class=k>return</span><span class=o>;</span>
  <span class=o>}</span>
  <span class=n>Client</span><span class=o>.</span><span class=na>handleActivityResult</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>intent</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></div><p>While in the static constructor of the <code>Library</code> class, they force the loading of <b class=red>libmain.so</b>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>static</span> <span class=o>{</span>
  <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;main&#34;</span><span class=o>);</span>
  <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;holoholo&#34;</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></div><p>Now, let&rsquo;s look at <b class=red>libmain.so</b></p>
<h4 id=libmain>
<a href=#toc><i class="fas fa-angle-up"></i>  libmain.so</a></h4>
<p>Compared to the original PokemonGO APK, <b class=red>libmain.so</b> in PGSharp is substantially larger. Moreover,
the ELF metadata leaks the original file name of the file:</p>
<pre tabindex=0><code class=language-console data-lang=console>$ readelf -d libmain.so
...
0x000000000000000e (SONAME)             Library soname: [libhela.so]
...
</code></pre><p>During the analysis of PGSharp, we find references to
<a href=https://en.wikipedia.org/wiki/Hela_%28comics%29 target=_blank rel=noopener>Hela</a>
in different places, like the package name
of the dynamically-loaded APK:<br> <code>me.underworld.helaplugin</code>.</p>
<p>Originally, the purpose of this library is to initialize some parts of the Unity engine but PGSharp
uses it to load its main payload.</p>
<p>In the cheating app, <b class=red>libmain.so</b> is responsible for:</p>
<ol>
<li>Initializing the Lua VM</li>
<li>Implementing Lua native C functions</li>
<li>Implementing JNI functions</li>
<li>Calling the Lua scripts</li>
</ol>
<p><b class=red>libmain.so</b> exposes <code>JNI_OnLoad</code> which is used as an entrypoint
to perform the actions listed above.</p>
<p>The JNI functions don&rsquo;t have a meaningful name but thanks to their callsites, we can figure out their purpose:</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:left>Description</th>
<th style=text-align:left>Rename</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>NRL</td>
<td style=text-align:left>Trigger Lua function from Java</td>
<td style=text-align:left>NativeRunLua</td>
</tr>
<tr>
<td style=text-align:left>NSMTC</td>
<td style=text-align:left>Trigger PGSharp Action</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>NOHRB</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>NativeOkHttpResponseByte</td>
</tr>
<tr>
<td style=text-align:left>NOHR</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>NativeOkHttpResponse</td>
</tr>
<tr>
<td style=text-align:left>NOHF</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>NativeOkHttpFailure</td>
</tr>
<tr>
<td style=text-align:left>NIOS</td>
<td style=text-align:left>Google Signing?</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>NIOR</td>
<td style=text-align:left><em>Seems not used</em></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>NOT</td>
<td style=text-align:left>Perform periodic actions on Lua threads</td>
<td style=text-align:left>NativeOnTimer</td>
</tr>
<tr>
<td style=text-align:left>NIPE</td>
<td style=text-align:left>Related to PokemonGO Plus</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>NIOF</td>
<td style=text-align:left><em>Seems to do nothing relevant</em></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<p>Similarly, for the Lua C closures, we get the following table:</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:left>Description</th>
<th style=text-align:left>Rename</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>callpgo</td>
<td style=text-align:left>Trigger Lua function from Java</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>add_unity_task</td>
<td style=text-align:left>Trigger PGSharp Action</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>initil2cppbase</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>initil2cpphooks</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>initil2cppmethods</td>
<td style=text-align:left>OkHtttp callback</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>newjbytearray</td>
<td style=text-align:left>Create a <em>Java</em> bytearray from Lua</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>nar</td>
<td style=text-align:left>-</td>
<td style=text-align:left>nativeAttestResponse</td>
</tr>
<tr>
<td style=text-align:left>ngak</td>
<td style=text-align:left>-</td>
<td style=text-align:left>nativeGetApiKey</td>
</tr>
<tr>
<td style=text-align:left>findclass</td>
<td style=text-align:left>Find a <em>Java</em> class from Lua</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>gettid</td>
<td style=text-align:left>Get Thread ID</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>logi</td>
<td style=text-align:left>Log info (empty)</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>logv</td>
<td style=text-align:left>Log verbose (empty)</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>init_plugin_natives</td>
<td style=text-align:left>Init Java layer (JNI + <code>nUSlwbRIjReLowOP</code>)</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>uf_whitelist</td>
<td style=text-align:left><em>empty</em></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>uf_forbid</td>
<td style=text-align:left><em>empty</em></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>uf_redirect</td>
<td style=text-align:left><em>empty</em></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left>fkinitjni</td>
<td style=text-align:left>Lua wrapper<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td>
<td style=text-align:left>FakeInitJNI</td>
</tr>
<tr>
<td style=text-align:left>fknalp</td>
<td style=text-align:left>Lua wrapper<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td>
<td style=text-align:left>FakeNativeAddLocationProvider</td>
</tr>
<tr>
<td style=text-align:left>fkngsu</td>
<td style=text-align:left>Lua wrapper<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td>
<td style=text-align:left>FakeNativeGpsStatusUpdate</td>
</tr>
<tr>
<td style=text-align:left>fknlu</td>
<td style=text-align:left>Lua wrapper<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td>
<td style=text-align:left>FakeNativeLocationUpdate</td>
</tr>
<tr>
<td style=text-align:left>getPoisFromCache</td>
<td style=text-align:left>Related to the autowalk feature</td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-5 role=button aria-expanded=false aria-controls=spoiler-5>
<i class="fas fa-table"></i>&nbsp;&nbsp;NRL Actions
</a>
</p>
<div class="collapse card" id=spoiler-5>
<div class=card-body>
<table>
<thead>
<tr>
<th style=text-align:left>Action</th>
<th style=text-align:left>Event Task</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>1</td>
<td style=text-align:left>plg.float.click</td>
</tr>
<tr>
<td style=text-align:left>2</td>
<td style=text-align:left>plg.float.remove</td>
</tr>
<tr>
<td style=text-align:left>3</td>
<td style=text-align:left>plg.map.tp</td>
</tr>
<tr>
<td style=text-align:left>4</td>
<td style=text-align:left>plg.setspeed</td>
</tr>
<tr>
<td style=text-align:left>5</td>
<td style=text-align:left>plg.randomwalk</td>
</tr>
<tr>
<td style=text-align:left>6</td>
<td style=text-align:left>plg.enablespoof</td>
</tr>
<tr>
<td style=text-align:left>7</td>
<td style=text-align:left>plg.joystart</td>
</tr>
<tr>
<td style=text-align:left>8</td>
<td style=text-align:left>plg.joystop</td>
</tr>
<tr>
<td style=text-align:left>9</td>
<td style=text-align:left>plg.entergame</td>
</tr>
<tr>
<td style=text-align:left>10</td>
<td style=text-align:left>plg.pause</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="alert alert-">
<div>
Long story short, PGSharp repackages the PokemonGO application and implements its payload in <b class=red>libmain.so</b>
</div>
</div>
<blockquote>
<p><em>But wait, since they repackage the application they have to re-sign the application and you won&rsquo;t tell me that PokemonGO does have
signature checks?</em></p>
</blockquote>
<center>
And this is where the fun begins!
<br><br>
</center>
<p>The functionalities of PGSharp heavily rely on hooking but not the hooking you might think of &mldr;</p>
<h3 id=signature-bypass>
<a href=#toc><i class="fas fa-angle-up"></i>  Signature Bypass</a></h3>
<p>As it is detailed in the next section, <b class=red>libmain.so</b> dynamically loads another APK. Within
this APK, and more precisely in the class <code>androidx.appcompat.app.AppCompatDelegateImpl</code><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, we can notice this method:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=cm>/* renamed from: g */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>proxifySignatureCheck</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>String</span> <span class=n>packageName</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getPackageName</span><span class=o>();</span>
  <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>aThreadCls</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;android.app.ActivityThread&#34;</span><span class=o>);</span>
  <span class=n>Object</span> <span class=n>mCurrentActivityThread</span> <span class=o>=</span> <span class=n>aThreadCls</span><span class=o>.</span><span class=na>getDeclaredMethod</span><span class=o>(</span><span class=s>&#34;currentActivityThread&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]).</span><span class=na>invoke</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>

  <span class=n>Field</span> <span class=n>sPackageManager</span> <span class=o>=</span> <span class=n>aThreadCls</span><span class=o>.</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;sPackageManager&#34;</span><span class=o>);</span>
  <span class=n>sPackageManager</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>

  <span class=n>Object</span> <span class=n>pm</span> <span class=o>=</span> <span class=n>sPackageManager</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>mCurrentActivityThread</span><span class=o>);</span>
  <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>IPackageManager</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;android.content.pm.IPackageManager&#34;</span><span class=o>);</span>
  <span class=n>SignatureMock</span> <span class=n>mock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SignatureMock</span><span class=o>(</span><span class=n>pm</span><span class=o>,</span> <span class=s>&#34;30820 [ ... ] aa001f55&#34;</span><span class=o>,</span> <span class=n>packageName</span><span class=o>)</span>
  <span class=n>Object</span> <span class=n>newProxyInstance</span> <span class=o>=</span> <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span><span class=n>IPackageManager</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(),</span>
                                                   <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>IPackageManager</span><span class=o>},</span> <span class=n>mock</span><span class=o>);</span>
  <span class=n>sPackageManager</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>mCurrentActivityThread</span><span class=o>,</span> <span class=n>newProxyInstance</span><span class=o>);</span>
  <span class=n>PackageManager</span> <span class=n>packageManager</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getPackageManager</span><span class=o>();</span>
  <span class=n>Field</span> <span class=n>mPM</span> <span class=o>=</span> <span class=n>packageManager</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;mPM&#34;</span><span class=o>);</span>
  <span class=n>mPM</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
  <span class=n>mPM</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>packageManager</span><span class=o>,</span> <span class=n>newProxyInstance</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></div><p>This code leverages the Java <em>hooking</em> API,
<a href=https://developer.android.com/reference/java/lang/reflect/Proxy target=_blank rel=noopener>java.lang.reflect.Proxy</a>,
to <em>proxify</em> the Android PackageManager ¯\_(ツ)_/¯.</p>
<p>The <em>mocked</em> PackageManager looks like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=nf>SignatureMock</span><span class=o>(</span><span class=n>Object</span> <span class=n>pm</span><span class=o>,</span> <span class=n>String</span> <span class=n>originalSignature</span><span class=o>,</span> <span class=n>String</span> <span class=n>packageName</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>this</span><span class=o>.</span><span class=na>mPackageManager</span> <span class=o>=</span> <span class=n>pm</span><span class=o>;</span>
  <span class=k>this</span><span class=o>.</span><span class=na>mOriginalSignature</span> <span class=o>=</span> <span class=n>originalSignature</span><span class=o>;</span>
  <span class=k>this</span><span class=o>.</span><span class=na>mPackageName</span> <span class=o>=</span> <span class=n>packageName</span><span class=o>;</span>
<span class=o>}</span>
<span class=nd>@Override</span> <span class=c1>// java.lang.reflect.InvocationHandler
</span><span class=c1></span><span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>Object</span> <span class=n>obj</span><span class=o>,</span> <span class=n>Method</span> <span class=n>inMeth</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>PackageInfo</span> <span class=n>packageInfo</span><span class=o>;</span>
  <span class=n>SigningInfo</span> <span class=n>signingInfo</span><span class=o>;</span>
  <span class=c1>// Hook getPackageInfo
</span><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=s>&#34;getPackageInfo&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>inMeth</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span> <span class=o>{</span>
    <span class=n>String</span> <span class=n>pkgName</span> <span class=o>=</span> <span class=o>(</span><span class=n>String</span><span class=o>)</span> <span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
    <span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=o>((</span><span class=n>Integer</span><span class=o>)</span> <span class=n>args</span><span class=o>[</span><span class=n>1</span><span class=o>]).</span><span class=na>intValue</span><span class=o>();</span>
    <span class=c1>// Handle both
</span><span class=c1></span>    <span class=c1>// GET_SIGNATURES           (0x00000040) - Deprecated in API 28
</span><span class=c1></span>    <span class=c1>// GET_SIGNING_CERTIFICATES (0x08000000)
</span><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>PackageManager</span><span class=o>.</span><span class=na>GET_SIGNATURES</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>mPackageName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>pkgName</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>PackageInfo</span> <span class=n>fakePkgInfo</span> <span class=o>=</span> <span class=o>(</span><span class=n>PackageInfo</span><span class=o>)</span> <span class=n>inMeth</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mPackageManager</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
      <span class=c1>// Fake the signature
</span><span class=c1></span>      <span class=n>fakePkgInfo</span><span class=o>.</span><span class=na>signatures</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Signature</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mOriginalSignature</span><span class=o>);</span>
      <span class=k>return</span> <span class=n>fakePkgInfo</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Build</span><span class=o>.</span><span class=na>VERSION</span><span class=o>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>28</span> <span class=o>&amp;&amp;</span>
              <span class=o>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>GET_SIGNING_CERTIFICATES</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>&amp;&amp;</span>
              <span class=k>this</span><span class=o>.</span><span class=na>mPackageName</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>pkgName</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
              <span class=o>(</span><span class=n>signingInfo</span> <span class=o>=</span> <span class=o>(</span><span class=n>packageInfo</span> <span class=o>=</span> <span class=o>(</span><span class=n>PackageInfo</span><span class=o>)</span> <span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mPackageManager</span><span class=o>,</span> <span class=n>args</span><span class=o>)).</span><span class=na>signingInfo</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>Field</span> <span class=n>FieldSigningDetails</span> <span class=o>=</span> <span class=n>signingInfo</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;mSigningDetails&#34;</span><span class=o>);</span>
      <span class=n>FieldSigningDetails</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
      <span class=n>Object</span> <span class=n>mSigningDetails</span> <span class=o>=</span> <span class=n>FieldSigningD</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>packageInfo</span><span class=o>);</span>
      <span class=n>Signature</span><span class=o>[]</span> <span class=n>fakeSigArray</span> <span class=o>=</span> <span class=o>{</span><span class=k>new</span> <span class=n>Signature</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mOriginalSignature</span><span class=o>)};</span>
      <span class=n>Field</span> <span class=n>FieldSignatures</span> <span class=o>=</span> <span class=n>mSigningDetails</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;signatures&#34;</span><span class=o>);</span>
      <span class=n>FieldSignatures</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
      <span class=n>FieldSignatures</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>FieldSigningDetails</span><span class=o>,</span> <span class=n>fakeSigArray</span><span class=o>);</span>
      <span class=k>return</span> <span class=n>packageInfo</span><span class=o>;</span>
    <span class=o>}</span>
  <span class=o>}</span>
  <span class=k>return</span> <span class=n>inMeth</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mPackageManager</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></div><p>In doing so, when PokemonGO accesses the PackageManager, it gets a <em>mocked</em> version of the PackageManager
that is <strong>controlled</strong> by PGSharp.
PGSharp changes the behavior of <code>getPackageInfo()</code> to return the real PokemonGO signature instead of its own.</p>
<p>The following figure outlines the process:</p>
<p><img src=mock_signature.png alt="Mock Android PackageManager"></p>
<h3 id=dynamic-apk-loading>
<a href=#toc><i class="fas fa-angle-up"></i>  Dynamic APK Loading</a></h3>
<p>In the Lua script <code>plugin.lua</code>, PGSharp defines an <code>init</code> function that performs the following
actions:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=kd>local</span> <span class=n>filesdir</span>     <span class=o>=</span> <span class=p>(</span><span class=n>ref.call_method</span><span class=p>)(</span><span class=n>runtime.app</span><span class=p>,</span> <span class=s2>&#34;getFilesDir&#34;</span><span class=p>,</span> <span class=s2>&#34;()Ljava/io/File;&#34;</span><span class=p>)</span>
<span class=kd>local</span> <span class=n>filesdirpath</span> <span class=o>=</span> <span class=p>(</span><span class=n>ref.call_method</span><span class=p>)(</span><span class=n>filesdir</span><span class=p>,</span> <span class=s2>&#34;getAbsolutePath&#34;</span><span class=p>,</span> <span class=s2>&#34;()Ljava/lang/String;&#34;</span><span class=p>)</span>
<span class=n>u_plugin_path</span>      <span class=o>=</span> <span class=p>(</span><span class=n>gh.ipf</span><span class=p>)(</span><span class=n>loadjstring</span><span class=p>(</span><span class=n>filesdirpath</span><span class=p>))</span>
</code></pre></div><p><code>ipf</code> is a function that takes the output of <code>cxt.getFilesDir().getAbsolutePath()</code> as parameter,
in other words, the path of the <em>files</em> directory of PokemonGO: <code>/data/data/com.nianticlabs.pokemongo/files</code>,
and returns a <code>u_plugin_path</code> as a Lua string.</p>
<p>If we look for <code>ipf</code> in the Lua scripts, we don&rsquo;t find any implementation. Actually, this
function is referenced in the <code>gamehelper()</code> function of <b class=red>libmain.so</b> where it is
linked as follows:</p>
<p><img src=ipf.png alt="Lua registering IPF"></p>
<p>So <code>ipf</code> is a native Lua C function registered with <code>lua_pushcclosure</code>.</p>
<p>Once we identified the location of <code>ipf</code>, the logic of the function can be summarized with this pseudo code:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=c1>// file_dir: /data/user/0/com.nianticlabs.pokemongo/files
</span><span class=c1></span><span class=kt>void</span> <span class=nf>ipf</span><span class=p>(</span><span class=n>lua_State</span> <span class=o>*</span><span class=n>L</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// std::string ctor @0xA4F00
</span><span class=c1></span>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>outpath</span> <span class=o>=</span> <span class=n>lua_tostring</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
  <span class=c1>// std::string::append @0xD868C
</span><span class=c1></span>  <span class=n>outpath</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span>
  <span class=n>outpath</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=s>&#34;LZZqoKpt.plg&#34;</span><span class=p>);</span>

  <span class=n>FILE</span><span class=o>*</span> <span class=n>fout</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=n>outpath</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span> <span class=s>&#34;wb&#34;</span><span class=p>);</span>

  <span class=c1>// @0x634424
</span><span class=c1></span>  <span class=n>extract_apk_file</span><span class=p>(</span><span class=n>FILE</span><span class=o>*</span> <span class=n>fout</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=nl>chunk</span> <span class=p>:</span> <span class=n>chunks</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>decode</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=mh>0x2710</span><span class=p>);</span>
      <span class=n>fwrite</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=mh>0x2710</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fout</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=n>fclose</span><span class=p>(</span><span class=n>fout</span><span class=p>);</span>
  <span class=n>lua_pushlstring</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>outpath</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>outpath</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>inline_decode</span><span class=p>(</span><span class=kt>uint8_t</span><span class=o>*</span> <span class=n>data</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Byte decoding
</span><span class=c1></span>    <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mh>0xb3</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>|</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x4c</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><div class="alert alert-">
<div>
Since the decoded file is written in the <code>/data</code> partition,
one can also pull the file from the device (this file is not removed when PGSharp stops running).
</div>
</div>
<p>The written file, <code>LZZqoKpt.plg</code>, is actually an APK that is loaded with <code>PathClassLoader</code> in the Lua script:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>u_classloader</span> <span class=o>=</span> <span class=p>(</span><span class=n>ref.new_instance</span><span class=p>)(</span><span class=s2>&#34;dalvik/system/PathClassLoader&#34;</span><span class=p>,</span>
                <span class=s2>&#34;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/ClassLoader;)V&#34;</span><span class=p>,</span>
                <span class=p>(</span><span class=n>env.NewStringUTF</span><span class=p>)(</span><span class=n>u_plugin_path</span><span class=p>),</span>
                <span class=n>nativeLibraryDir</span><span class=p>,</span>
                <span class=n>gh.pgo_classloader</span><span class=p>);</span>
</code></pre></div><div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-8 role=button aria-expanded=false aria-controls=spoiler-8>
<i class="fas fa-file-code"></i>&nbsp;&nbsp;Rest of the function
</a>
</p>
<div class="collapse card" id=spoiler-8>
<div class=card-body>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>u_plugin_cls</span>                <span class=o>=</span> <span class=n>findclass</span><span class=p>(</span><span class=s2>&#34;me/underworld/helaplugin/PL&#34;</span><span class=p>,</span> <span class=n>u_classloader</span><span class=p>)</span>
<span class=n>u_global_cls</span>                <span class=o>=</span> <span class=n>findclass</span><span class=p>(</span><span class=s2>&#34;me/underworld/helaplugin/GL&#34;</span><span class=p>,</span> <span class=n>u_classloader</span><span class=p>)</span>
<span class=n>u_runnable_cls</span>              <span class=o>=</span> <span class=n>findclass</span><span class=p>(</span><span class=s2>&#34;me/underworld/helaplugin/HR&#34;</span><span class=p>,</span> <span class=n>u_classloader</span><span class=p>)</span>

<span class=n>u_global_cls</span>                <span class=o>=</span> <span class=p>(</span><span class=n>env.NewGlobalRef</span><span class=p>)(</span><span class=n>u_global_cls</span><span class=p>)</span>
<span class=n>u_plugin_cls</span>                <span class=o>=</span> <span class=p>(</span><span class=n>env.NewGlobalRef</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>)</span>
<span class=n>u_classloader</span>               <span class=o>=</span> <span class=p>(</span><span class=n>env.NewGlobalRef</span><span class=p>)(</span><span class=n>u_classloader</span><span class=p>)</span>
<span class=n>u_runnable_cls</span>              <span class=o>=</span> <span class=p>(</span><span class=n>env.NewGlobalRef</span><span class=p>)(</span><span class=n>u_runnable_cls</span><span class=p>)</span>
<span class=n>u_runnable_init_mid</span>         <span class=o>=</span> <span class=p>(</span><span class=n>env.GetMethodID</span><span class=p>)(</span><span class=n>u_runnable_cls</span><span class=p>,</span> <span class=s2>&#34;&lt;init&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;(ILjava/lang/Object;)V&#34;</span><span class=p>)</span>
<span class=n>u_geturl_mid</span>                <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>,</span> <span class=s2>&#34;GU&#34;</span><span class=p>,</span> <span class=s2>&#34;(Ljava/lang/String;Ljava/lang/String;)I&#34;</span><span class=p>)</span>
<span class=n>u_postString_mid</span>            <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>,</span> <span class=s2>&#34;vtEdUZmWQYAgtGWs&#34;</span><span class=p>,</span> <span class=s2>&#34;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)I&#34;</span><span class=p>)</span>
<span class=n>u_postBytes_mid</span>             <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>,</span> <span class=s2>&#34;BbTwaTXurePBxTDt&#34;</span><span class=p>,</span> <span class=s2>&#34;(Ljava/lang/String;[BLjava/lang/String;)I&#34;</span><span class=p>)</span>
<span class=n>u_onLuaMessage_mid</span>          <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>,</span> <span class=s2>&#34;tFAxNZCNHOXBTYGM&#34;</span><span class=p>,</span> <span class=s2>&#34;(ILjava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;&#34;</span><span class=p>)</span>
<span class=n>u_global_updatelocation_mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_global_cls</span><span class=p>,</span> <span class=s2>&#34;ul&#34;</span><span class=p>,</span> <span class=s2>&#34;(DD)V&#34;</span><span class=p>)</span>
<span class=n>u_global_savelocation_mid</span>   <span class=o>=</span> <span class=p>(</span><span class=n>env.GetStaticMethodID</span><span class=p>)(</span><span class=n>u_global_cls</span><span class=p>,</span> <span class=s2>&#34;sl&#34;</span><span class=p>,</span> <span class=s2>&#34;()V&#34;</span><span class=p>)</span>

<span class=p>(</span><span class=n>gh.init_plugin_natives</span><span class=p>)(</span><span class=n>u_classloader</span><span class=p>)</span>
<span class=p>(</span><span class=n>ref.call_static_method</span><span class=p>)(</span><span class=n>u_plugin_cls</span><span class=p>,</span>
                         <span class=s2>&#34;rDymrMuxPIlIESFe&#34;</span><span class=p>,</span> <span class=s2>&#34;(Landroid/app/Application;Ljava/lang/String;I)V&#34;</span><span class=p>,</span>
                         <span class=n>runtime.app</span><span class=p>,</span> <span class=p>(</span><span class=n>env.NewStringUTF</span><span class=p>)(</span><span class=n>u_plugin_path</span><span class=p>),</span> <span class=n>runtime.log_level</span><span class=p>)</span>

<span class=kd>local</span> <span class=n>cls</span>              <span class=o>=</span> <span class=p>(</span><span class=n>gh.findclass</span><span class=p>)(</span><span class=s2>&#34;me.underworld.helaplugin.HLVM&#34;</span><span class=p>,</span> <span class=n>u_classloader</span><span class=p>)</span>
<span class=kd>local</span> <span class=n>hlviewmanagerref</span> <span class=o>=</span> <span class=p>(</span><span class=n>ref.call_static_method</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=s2>&#34;getInstance&#34;</span><span class=p>,</span> <span class=s2>&#34;()Lme/underworld/helaplugin/HLVM;&#34;</span><span class=p>)</span>
<span class=n>u_sm_mid</span>               <span class=o>=</span> <span class=p>(</span><span class=n>env.GetMethodID</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=s2>&#34;SM&#34;</span><span class=p>,</span> <span class=s2>&#34;(Ljava/lang/String;I)V&#34;</span><span class=p>)</span>
<span class=n>u_setviewshow_mid</span>      <span class=o>=</span> <span class=p>(</span><span class=n>env.GetMethodID</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=s2>&#34;SVC&#34;</span><span class=p>,</span> <span class=s2>&#34;(Ljava/lang/String;Z)V&#34;</span><span class=p>)</span>
<span class=n>u_hlviewmanager</span>        <span class=o>=</span> <span class=p>(</span><span class=n>env.NewGlobalRef</span><span class=p>)(</span><span class=n>hlviewmanagerref</span><span class=p>)</span>
<span class=n>plugin.classloader</span>     <span class=o>=</span> <span class=n>u_classloader</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id=gps-spoofing>
<a href=#toc><i class="fas fa-angle-up"></i>  GPS Spoofing</a></h3>
<p>Since PokemonGO heavily relies on the user&rsquo;s location, the must-have feature for the PokemonGO cheat engines
is to be able to spoof the GPS location.</p>
<p>The genuine PokemonGO application manages the user location through the Java class <code>NianticLocationManager</code>,
which exposes three natives functions:</p>
<ol>
<li><span class=blue>nativeAddLocationProviders(Context ctx)</span></li>
<li><span class=blue>nativeGpsStatusUpdate(int i, SatelliteInfo[] info)</span></li>
<li><span class=blue>nativeLocationUpdate(String providerName, Location location, &mldr;)</span></li>
</ol>
<p><code>nativeAddLocationProviders</code> aims at instantiating the different location providers as Java object:</p>
<ol>
<li>FusedLocationProvider</li>
<li>GnssLocationProvider</li>
<li>GpsLocationProvider</li>
<li>NetworkLocationProvider</li>
</ol>
<p>while <code>nativeLocationUpdate</code> and <code>nativeGpsStatusUpdate</code> are a kind of callbacks triggered when there is
a new user location to consider.</p>
<p>The implementation of <code>nativeLocationUpdate</code> checks natively if the location object given in the second parameter
is <em>mocked</em> (cf.
<a href=https://developer.android.com/reference/android/location/Location#isMock%28%29 target=_blank rel=noopener>isMock()</a> or
<a href=https://developer.android.com/reference/android/location/Location#isFromMockProvider%28%29 target=_blank rel=noopener>isFromMockProvider()</a>).</p>
<p>Actually PGSharp hooks two of these three native methods:</p>
<ol>
<li><span class=red><i class="fas fa-cogs"> </i>nativeAddLocationProviders(Context ctx)</span></li>
<li><span class=blue>nativeGpsStatusUpdate(int i, SatelliteInfo[] info)</span></li>
<li><span class=red><i class="fas fa-cogs"> </i>nativeLocationUpdate(String provider, Location location, &mldr;)</span></li>
</ol>
<p>By hooking <code>nativeLocationUpdate</code>, they can modify the value of the <code>Location</code> parameter to change
the real location.</p>
<blockquote>
<p><em>&ldquo;You assert that PGSharp hooks <code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> in
<code>libNianticLabsPlugin.so</code>, but this library is protected by a commercial obfuscator
which has anti-hooks features. How do they hook these functions?"</em></p>
</blockquote>
<p>And this is where the fun reaches another level 🚀</p>
<h3 id=jnienv-proxifier>
<a href=#toc><i class="fas fa-angle-up"></i>  JNIEnv Proxifier</a></h3>
<p>I would assume that <code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> are critical
enough to be protected against hooking. It turns out that PGSharp embeds a hooking framework to hook
Unity functions, but they don&rsquo;t use it on these functions.</p>
<center>
<b>
The authors of PGSharp found a subtle trick to circumvent the anti-hook protection.<br><br>
</b>
</center>
<p><code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> are JNI functions
that are <strong>dynamically</strong> registered by <code>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=p>...)</span> <span class=p>{</span>
  <span class=n>env</span><span class=o>-&gt;</span><span class=n>RegisterNatives</span><span class=p>(...);</span>
<span class=p>}</span>
</code></pre></div><p>The <code>env</code> parameter refers to the JNIEnv structure which is an array of function pointers:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=nc>JNINativeInterface</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=n>jclass</span>      <span class=p>(</span><span class=o>*</span><span class=n>GetObjectClass</span><span class=p>)(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=p>,</span> <span class=n>jobject</span><span class=p>);</span>
  <span class=n>jboolean</span>    <span class=p>(</span><span class=o>*</span><span class=n>IsInstanceOf</span><span class=p>)(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=p>,</span> <span class=n>jobject</span><span class=p>,</span> <span class=n>jclass</span><span class=p>);</span>
  <span class=n>jmethodID</span>   <span class=p>(</span><span class=o>*</span><span class=n>GetMethodID</span><span class=p>)(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=p>,</span> <span class=n>jclass</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span><span class=p>);</span>
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p>The values
of these pointers are defined by the implementation of the &ldquo;JVM&rdquo; which is, for Android, the <strong>A</strong>ndroid <strong>R</strong>un<strong>T</strong>ime (ART).</p>
<p>For instance, <code>FindClass</code> is actually a pointer
to <code>art::{CheckJNI, JNIImpl}::FindClass</code> located in <code>art/runtime/jni/{jni_internal, check_jni}.cc</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>static</span> <span class=n>jclass</span> <span class=nf>FindClass</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Runtime</span><span class=o>*</span> <span class=n>runtime</span> <span class=o>=</span> <span class=n>Runtime</span><span class=o>::</span><span class=n>Current</span><span class=p>();</span>
  <span class=n>ClassLinker</span><span class=o>*</span> <span class=n>class_linker</span> <span class=o>=</span> <span class=n>runtime</span><span class=o>-&gt;</span><span class=n>GetClassLinker</span><span class=p>();</span>
  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>descriptor</span><span class=p>(</span><span class=n>NormalizeJniClassDescriptor</span><span class=p>(</span><span class=n>name</span><span class=p>));</span>
  <span class=n>ScopedObjectAccess</span> <span class=n>soa</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
  <span class=n>ObjPtr</span><span class=o>&lt;</span><span class=n>mirror</span><span class=o>::</span><span class=n>Class</span><span class=o>&gt;</span> <span class=n>c</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>runtime</span><span class=o>-&gt;</span><span class=n>IsStarted</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>StackHandleScope</span><span class=o>&lt;</span><span class=mi>1</span><span class=o>&gt;</span> <span class=n>hs</span><span class=p>(</span><span class=n>soa</span><span class=p>.</span><span class=n>Self</span><span class=p>());</span>
    <span class=n>Handle</span><span class=o>&lt;</span><span class=n>mirror</span><span class=o>::</span><span class=n>ClassLoader</span><span class=o>&gt;</span> <span class=n>class_loader</span><span class=p>(</span><span class=n>hs</span><span class=p>.</span><span class=n>NewHandle</span><span class=p>(</span><span class=n>GetClassLoader</span><span class=o>&lt;</span><span class=n>kEnableIndexIds</span><span class=o>&gt;</span><span class=p>(</span><span class=n>soa</span><span class=p>)));</span>
    <span class=n>c</span> <span class=o>=</span> <span class=n>class_linker</span><span class=o>-&gt;</span><span class=n>FindClass</span><span class=p>(</span><span class=n>soa</span><span class=p>.</span><span class=n>Self</span><span class=p>(),</span> <span class=n>descriptor</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>class_loader</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>c</span> <span class=o>=</span> <span class=n>class_linker</span><span class=o>-&gt;</span><span class=n>FindSystemClass</span><span class=p>(</span><span class=n>soa</span><span class=p>.</span><span class=n>Self</span><span class=p>(),</span> <span class=n>descriptor</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>soa</span><span class=p>.</span><span class=n>AddLocalReference</span><span class=o>&lt;</span><span class=n>jclass</span><span class=o>&gt;</span><span class=p>(</span><span class=n>c</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>If we hook <code>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit</code> from the <strong>genuine</strong> PokemonGO,
and we check where the pointers of the <code>JNIEnv</code> structure point to, we get this kind of output:</p>
<p><img src=jni_ptr_clean.png alt="Normal values of the JNI Pointers"></p>
<p>This output is consistent with what we said about the <em>JVM</em> and the runtime ART.
If we do the same check <strong>on PGSharp</strong>, we get this result:</p>
<p><img src=jni_ptr_cheat.png alt="Modified values of the JNI Pointers"></p>
<p>As we can see, some pointers have been relocated to point in <b class=red>libmain.so</b>:</p>
<center>
<table>
<thead>
<tr>
<th style=text-align:left>JNI Function</th>
<th style=text-align:left>Offset in libmain.so (v1.33.0)</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>GetMethodID</td>
<td style=text-align:left>0x14540c</td>
</tr>
<tr>
<td style=text-align:left>CallObjectMethodV</td>
<td style=text-align:left>0x145194</td>
</tr>
<tr>
<td style=text-align:left>CallVoidMethodV</td>
<td style=text-align:left>0x145040</td>
</tr>
<tr>
<td style=text-align:left>RegisterNatives</td>
<td style=text-align:left>0x1452f0</td>
</tr>
</tbody>
</table>
</center>
<p>It means that when <code>libNianticLabsPlugin.so</code> is calling one of the functions listed above,
the execution is forwarded to <b class=red>libmain.so</b> instead of <b class=green>libart.so</b>.</p>
<p><img src=jnienv_proxy.png alt="JNIEnv Proxy"></p>
<p>PGSharp proxifies these functions for the following purposes:</p>
<p><strong>GetMethodID</strong></p>
<p>  To monitor:</p>
<ol>
<li>SafetyNetService.attest</li>
<li>SafetyNetService.cancel</li>
<li>NianticLocationManager.addLocationProvider</li>
</ol>
<p><strong>CallVoidMethodV</strong></p>
<p>  To monitor the parameters of:</p>
<ol>
<li>SafetyNetService.attest (to intercept the nonce)</li>
<li>SafetyNetService.cancel</li>
</ol>
<p><strong>RegisterNatives</strong></p>
<p>  Proxified to get, and potentially change, the effective location of the <br>
  <code>libNianticLabsPlugin.so</code> JNI functions:</p>
<ol>
<li>nativeAttestResponse</li>
<li>nativeGetApiKey</li>
<li>nativeAddLocationProviders</li>
<li>nativeLocationUpdate</li>
<li>initJni</li>
<li>nativeInjectEvent</li>
<li>nativeUnitySendMessage</li>
<li>nativeRender</li>
<li>nativeMuteMasterAudio</li>
</ol>
<p>By managing the function <code>JNIEnv::RegisterNatives</code>, they are able to change the value of <code>JNINativeMethod.fnPtr</code>,
such as when PokemonGO calls <code>nativeLocationUpdate</code>, it actually calls a function managed by PGSharp.</p>
<p>It results that JNI functions used by <code>libNianticLabsPlugin.so</code> have been <em>redefined</em>:</p>
<table>
<thead>
<tr>
<th style=text-align:left>JNI Function</th>
<th style=text-align:left>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><b class=red>NianticLocationManager.nativeAddLocationProviders</b></td>
<td style=text-align:left><b class=red>libmain.so!ea868</b></td>
</tr>
<tr>
<td style=text-align:left>NianticLocationManager.nativeGpsStatusUpdate</td>
<td style=text-align:left>libNianticLabsPlugin.so!bc508</td>
</tr>
<tr>
<td style=text-align:left><b class=red>NianticLocationManager.nativeLocationUpdate</b></td>
<td style=text-align:left><b class=red>libmain.so!ea8bc</b></td>
</tr>
<tr>
<td style=text-align:left>NLog.nativeDispatchLogMessage</td>
<td style=text-align:left>libNianticLabsPlugin.so!4beaa0</td>
</tr>
<tr>
<td style=text-align:left>NetworkConnectivity.nativeNotifyNetworkStateChanged</td>
<td style=text-align:left>libNianticLabsPlugin.so!6f8118</td>
</tr>
<tr>
<td style=text-align:left>NianticTrustManager.nativeCheckClientTrusted</td>
<td style=text-align:left>libNianticLabsPlugin.so!9b9cc</td>
</tr>
<tr>
<td style=text-align:left>NianticTrustManager.nativeCheckServerTrusted</td>
<td style=text-align:left>libNianticLabsPlugin.so!73b42c</td>
</tr>
<tr>
<td style=text-align:left>NianticTrustManager.nativeGetAcceptedIssuers</td>
<td style=text-align:left>libNianticLabsPlugin.so!6dc5c8</td>
</tr>
<tr>
<td style=text-align:left>WebsocketController.nativeOnDidClose</td>
<td style=text-align:left>libNianticLabsPlugin.so!6fcabc</td>
</tr>
<tr>
<td style=text-align:left>WebsocketController.nativeOnDidFail</td>
<td style=text-align:left>libNianticLabsPlugin.so!4a0d0c</td>
</tr>
<tr>
<td style=text-align:left>WebsocketController.nativeOnDidOpen</td>
<td style=text-align:left>libNianticLabsPlugin.so!5922b0</td>
</tr>
<tr>
<td style=text-align:left>WebsocketController.nativeOnDidReceiveData</td>
<td style=text-align:left>libNianticLabsPlugin.so!742fa8</td>
</tr>
<tr>
<td style=text-align:left>SafetyNetService.nativeAttestResponse</td>
<td style=text-align:left>libNianticLabsPlugin.so!5ea1b8</td>
</tr>
<tr>
<td style=text-align:left>SafetyNetService.nativeGetApiKey</td>
<td style=text-align:left>libNianticLabsPlugin.so!6bc60</td>
</tr>
<tr>
<td style=text-align:left>NianticSensorManager.nativeCompassUpdate</td>
<td style=text-align:left>libNianticLabsPlugin.so!4b9bc0</td>
</tr>
<tr>
<td style=text-align:left>NianticSensorManager.nativeSensorUpdate</td>
<td style=text-align:left>libNianticLabsPlugin.so!177c44</td>
</tr>
</tbody>
</table>
<h3 id=unity-hooks>
<a href=#toc><i class="fas fa-angle-up"></i>  Unity Hooks</a></h3>
<p>In addition to GPS spoofing, PGSharp provides other functionalities such as,
Pokemon feed, skip evolve animation &mldr;</p>
<p>In the genuine PokemonGO application, these functionalities are implemented in the Unity layer
that is <em>compiled</em> into <code>libil2cpp.so</code>.</p>
<p>To perform these functionalities, PGSharp hooks (hooking like Frida) some of these Unity functions.</p>
<p>They tried to hide<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> the underlying hooking framework used to perform these hooks, unfortunately they missed
to remove important strings:</p>
<pre tabindex=0><code class=language-console data-lang=console>$ strings ./libmain.so|grep -i -E &quot;\w\+\.cc&quot;
E:/work/code/Hela/app/src/main/cpp/Dobby/source/InterceptRouting/Routing/FunctionInlineReplace/FunctionInlineReplaceExport.cc
E:/work/code/Hela/app/src/main/cpp/Dobby/source/TrampolineBridge/Trampoline/arm64/trampoline-arm64.cc
E:/work/code/Hela/app/src/main/cpp/Dobby/source/MemoryAllocator/MemoryArena.cc
E:/work/code/Hela/app/src/main/cpp/Dobby/source/InstructionRelocation/arm64/ARM64InstructionRelocation.cc
E:/work/code/Hela/app/src/main/cpp/Dobby/source/UserMode/PlatformUtil/Linux/ProcessRuntimeUtility.cc
E:/work/code/Hela/app/src/main/cpp/Dobby/source/UserMode/UnifiedInterface/platform-posix.cc
</code></pre><p>So the hooking framework is Dobby:</p>
<center>
<i class="fas fa-github"></i>&nbsp;&nbsp;&nbsp;<a href=https://github.com/jmpews/Dobby target=_blank rel=noopener>https://github.com/jmpews/Dobby</a>
<br> <br>
</center>
<p>Unity hooks start, in the script <code>init.lua</code> of PGSharp where they wait for the loading of <code>libil2cpp.so</code><sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>set_event_handler</span><span class=p>(</span><span class=s2>&#34;pgo.il2ready&#34;</span><span class=p>,</span>
  <span class=kr>function</span><span class=p>(</span><span class=n>il2base</span><span class=p>)</span>
    <span class=n>runtime.il2base</span> <span class=o>=</span> <span class=n>il2base</span><span class=p>;</span>
    <span class=p>(</span><span class=n>gh.initil2cppmethods</span><span class=p>)();</span>
    <span class=p>(</span><span class=n>gh.initil2cpphooks</span><span class=p>)();</span>
  <span class=kr>end</span>
<span class=p>)</span>
</code></pre></div><p><code>initil2cppmethods()</code> aims at resolving the address of PokemonGO Unity functions needed to perform cheating actions,
while <code>initil2cpphooks()</code> dobby-hooks some Unity functions to change their behaviour.
In the version 1.33 of PGSharp, they hook 207 functions
of <code>libil2cpp.so</code> and we will take one of them to detail the internal mechanisms:</p>
<ul>
<li><code>UnityEngine.Application$$OpenURL</code></li>
</ul>
<p>First of all, if we look at the symbols or the strings of <code>libil2cpp.so</code>, we don&rsquo;t find meaningful information that could
help to figure out the original purpose of the Unity functions. In fact, the Unity metadata are embedded
in <code>global-metadata.dat</code>, and to recover the bindings between this file
and <code>libil2cpp.so</code>, we can use
<a href=https://github.com/Perfare/Il2CppDumper target=_blank rel=noopener>Perfare/Il2CppDumper</a>.</p>
<p>They compute the absolute of a Unity function by adding the offset provided by <code>global-metadata.dat</code>
to the base address of <code>libil2cpp.so</code>. Here is an example <code>UnityEngine.Application$$OpenURL</code>:</p>
<pre tabindex=0><code class=language-arm data-lang=arm>MOV   W13, 0x4bfeea0                   ; Offset of the function (thanks to global-metadata.dat)
ADRP  X14, #Application_OpenURL
ADD   X13, X8, X13                     ; Add the libil2cpp.so base address
STR   X13, [X14, #Application_OpenURL] ; Store the absolute address in libmain.so
</code></pre><p>The function associated with <code>initil2cpphooks()</code> is quite large as shown in the figure below:</p>
<p><img src=initil2cpphooks.png alt=initil2cpphooks></p>
<p>Actually, the function is large but easily understandable statically<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>. The right-hand side of the figure is actually
the <code>catch { ... }</code> handlers of the exceptions, while the left-hand side that goes down, initializes
C++ objects. In this area of the CFG, we find the same pattern that repeats all the way down:</p>
<p><img src=dobby_hook_vtable.png alt="Dobby Hooking VTable"></p>
<p>From what we can see, it initializes a C++ object (on the stack) and the first instructions setup the
VTable. We can find the relevant function in the last entry of the VTable that contains the hooking logic:</p>
<p><img src=hook_OpenURL.png alt="Dobby Hooking OpenURL"></p>
<p>From this code, we can see that they perform the resolution of the absolute address of
<code>UnityEngine.Application$$OpenURL</code>. Also, thanks to the prototype of <code>DobbyHook()</code> we can
quickly understand that the new behavior of <code>OpenURL</code> is located in the function <code>sub_6C983C</code>:</p>
<p><img src=il2cpp_hooks.png alt="Dobby Hooking OpenURL"></p>
<p>In this hook, they check if PokemonGO is opening its Google Play URL and redirect the user to the PGSharp home page.</p>
<h3 id=network>
<a href=#toc><i class="fas fa-angle-up"></i>  Network Communications and Encryption</a></h3>
<p>The cheating application communicates with its servers through the TLS/HTTP protocol and adds another layer
of encryption on the top of TLS. To encrypt the HTTP payload, they use AES in the CBC mode.
We can identify the AES algorithm thanks to clear S-BOX present in the <code>.rodata</code> section.</p>
<p>It seems that they use different keys, depending on the endpoint the application targets but
we can retrieve them by hooking the AES key schedule function. It results that we can decrypt the communication
between the application and the PGSharp servers<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>.</p>
<p>Here are examples of endpoints and the data sent by PGSharp:</p>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-9 role=button aria-expanded=false aria-controls=spoiler-9>
<i class="fas fa-link"></i>&nbsp;&nbsp;hazelnuts
</a>
</p>
<div class="collapse card" id=spoiler-9>
<div class=card-body>
<ul>
<li><strong>POST <code>hazelnuts</code></strong>
<ul>
<li>Action: Handshake</li>
<li>Request:
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=p>{</span>
    <span class=nt>&#34;bid&#34;</span><span class=p>:</span> <span class=s2>&#34;com.nianticlabs.pokemongo&#34;</span><span class=p>,</span>
    <span class=nt>&#34;clt&#34;</span><span class=p>:</span> <span class=s2>&#34;pgs&#34;</span><span class=p>,</span>
    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;Samsung A40&#34;</span><span class=p>,</span>
    <span class=nt>&#34;lv&#34;</span><span class=p>:</span> <span class=mi>-1</span><span class=p>,</span>
    <span class=nt>&#34;nonce&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;nonce_key&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;pgver&#34;</span><span class=p>:</span> <span class=s2>&#34;0.221.0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;00000000-00000000-[...]&#34;</span><span class=p>,</span>
    <span class=nt>&#34;ver&#34;</span><span class=p>:</span> <span class=s2>&#34;1.33.0&#34;</span>
  <span class=p>}</span>
</code></pre></div></li>
<li>Response:
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;err&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
  <span class=nt>&#34;shiny&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;List of shiny&#34;</span><span class=p>],</span>
  <span class=nt>&#34;hotplaces&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;🇧🇷 Consolacao, São Paulo, Brazil&#34;</span><span class=p>,</span>
      <span class=nt>&#34;lat&#34;</span><span class=p>:</span> <span class=mf>-23.5512</span><span class=p>,</span>
      <span class=nt>&#34;lng&#34;</span><span class=p>:</span> <span class=mf>-46.6584</span>
    <span class=p>},</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-10 role=button aria-expanded=false aria-controls=spoiler-10>
<i class="fas fa-link"></i>&nbsp;&nbsp;Cw8dfkXpW7mq2i
</a>
</p>
<div class="collapse card" id=spoiler-10>
<div class=card-body>
<ul>
<li><strong>POST <code>Cw8dfkXpW7mq2i</code></strong>
<ul>
<li>Action: <code>PGS_ACTIONS.GETPLAYER</code></li>
<li>Request:
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;bid&#34;</span><span class=p>:</span> <span class=s2>&#34;com.nianticlabs.pokemongo&#34;</span><span class=p>,</span>
  <span class=nt>&#34;clt&#34;</span><span class=p>:</span> <span class=s2>&#34;pgs&#34;</span><span class=p>,</span>
  <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;Samsung A40&#34;</span><span class=p>,</span>
  <span class=nt>&#34;lv&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
  <span class=nt>&#34;nonce&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;nonce_key&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;pgver&#34;</span><span class=p>:</span> <span class=s2>&#34;0.221.0&#34;</span><span class=p>,</span>
  <span class=nt>&#34;player&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;ban&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;captured&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
    <span class=nt>&#34;encountered&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
    <span class=nt>&#34;kmwalked&#34;</span><span class=p>:</span> <span class=mf>10.50</span><span class=p>,</span>
    <span class=nt>&#34;outage&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;pid&#34;</span><span class=p>:</span> <span class=s2>&#34;[redacted]&#34;</span><span class=p>,</span>
    <span class=nt>&#34;serverlo&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;susp&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;suspa&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;visits&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;warn&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;warna&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;warndt&#34;</span><span class=p>:</span> <span class=mi>623234511000000000</span><span class=p>,</span>
    <span class=nt>&#34;warntm&#34;</span><span class=p>:</span> <span class=mi>0</span>
  <span class=p>},</span>
  <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;00000000-00000000-[...]&#34;</span><span class=p>,</span>
  <span class=nt>&#34;ver&#34;</span><span class=p>:</span> <span class=s2>&#34;1.33.0&#34;</span>
<span class=p>}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-11 role=button aria-expanded=false aria-controls=spoiler-11>
<i class="fas fa-link"></i>&nbsp;&nbsp;SSZgBPn6Ixq2ZK
</a>
</p>
<div class="collapse card" id=spoiler-11>
<div class=card-body>
<ul>
<li><strong>POST <code>SSZgBPn6Ixq2ZK</code></strong>
<ul>
<li>Action: <code>PGS_ACTIONS.GETREPORTABLE</code></li>
<li>Request:
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
<span class=nt>&#34;bid&#34;</span><span class=p>:</span> <span class=s2>&#34;com.nianticlabs.pokemongo&#34;</span><span class=p>,</span>
<span class=nt>&#34;clt&#34;</span><span class=p>:</span> <span class=s2>&#34;pgs&#34;</span><span class=p>,</span>
<span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;Samsung A40&#34;</span><span class=p>,</span>
<span class=nt>&#34;lv&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
<span class=nt>&#34;nonce&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
<span class=nt>&#34;nonce_key&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
<span class=nt>&#34;pgver&#34;</span><span class=p>:</span> <span class=s2>&#34;0.221.0&#34;</span><span class=p>,</span>
<span class=nt>&#34;raid&#34;</span><span class=p>:</span> <span class=p>[</span>
  <span class=p>{</span>
    <span class=nt>&#34;battle&#34;</span><span class=p>:</span> <span class=mi>1634490000000</span><span class=p>,</span>
    <span class=nt>&#34;campaignId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;complete&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;costume&#34;</span><span class=p>:</span> <span class=mi>12233</span><span class=p>,</span>
    <span class=nt>&#34;dex&#34;</span><span class=p>:</span> <span class=mi>326</span><span class=p>,</span>
    <span class=nt>&#34;eligible&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;end&#34;</span><span class=p>:</span> <span class=mi>1634490000000</span><span class=p>,</span>
    <span class=nt>&#34;exclusive&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;form&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;free&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;gender&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;hidden&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;lat&#34;</span><span class=p>:</span> <span class=mf>0.1234</span><span class=p>,</span>
    <span class=nt>&#34;lng&#34;</span><span class=p>:</span> <span class=mf>5.6789</span><span class=p>,</span>
    <span class=nt>&#34;lv&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
    <span class=nt>&#34;mov1&#34;</span><span class=p>:</span> <span class=mi>163</span><span class=p>,</span>
    <span class=nt>&#34;mov2&#34;</span><span class=p>:</span> <span class=mi>90</span><span class=p>,</span>
    <span class=nt>&#34;schedule&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;seed&#34;</span><span class=p>:</span> <span class=mi>5000000</span><span class=p>,</span>
    <span class=nt>&#34;spawn&#34;</span><span class=p>:</span> <span class=mi>1634400000000</span><span class=p>,</span>
    <span class=nt>&#34;team&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;web&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;wec&#34;</span><span class=p>:</span> <span class=mi>3</span>
  <span class=p>},</span>
<span class=p>],</span>
<span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;00000000-00000000-[...]&#34;</span><span class=p>,</span>
<span class=nt>&#34;ver&#34;</span><span class=p>:</span> <span class=s2>&#34;1.33.0&#34;</span>
<span class=p>}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-12 role=button aria-expanded=false aria-controls=spoiler-12>
<i class="fas fa-link"></i>&nbsp;&nbsp;/pga/keycode/v-q2mgqcyji/
</a>
</p>
<div class="collapse card" id=spoiler-12>
<div class=card-body>
<ul>
<li><strong>POST <code>/pga/keycode/v-q2mgqcyji/</code></strong>
<ul>
<li>Action: Activate PGSharp with a premium key</li>
<li>Request:
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;ver&#34;</span><span class=p>:</span> <span class=s2>&#34;1.33.0&#34;</span><span class=p>,</span>
  <span class=nt>&#34;gi&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;AVerySecretKey&#34;</span><span class=p>,</span>
  <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;Samsung A40&#34;</span><span class=p>,</span>
  <span class=nt>&#34;clt&#34;</span><span class=p>:</span> <span class=s2>&#34;pgs&#34;</span><span class=p>,</span>
  <span class=nt>&#34;ua&#34;</span><span class=p>:</span> <span class=s2>&#34;Samsung A40/11/[redacted]/arm64-v8a/[redacted]/unknow/unknown/English&#34;</span><span class=p>,</span>
  <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;00000000-00000000-[...]&#34;</span>
<span class=p>}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<h3 id=safetynet>
<a href=#toc><i class="fas fa-angle-up"></i>  SafetyNet</a></h3>
<p><img src=snet.svg alt=safetynet></p>
<div class="alert alert-warning">
<div>
I skimmed this layer this weekend, so some parts might be inaccurate or wrong.
</div>
</div>
<p>In addition to standard code obfuscation, PokemonGO uses SafetyNet as an attestation mechanism.
Similarly to the GPS management, we find a (non-obfuscated) Java layer implemented in the class
<code>SafetyNetService</code>. This class exposes two native functions:</p>
<ol>
<li><span class=blue>String nativeGetApiKey()</span></li>
<li><span class=blue>void nativeAttestResponse(byte[] nonce, String jwtResult)</span></li>
</ol>
<p>The implementation of these two functions is obfuscated within <code>libNianticLabsPlugin.so</code>.</p>
<p>The first function is used to get the Google SafetyNet API key (<code>AIzaSyCh8l[...]_eOTXhM4</code>) while the second one,
is involved in the validation of the SafetyNet attestation.</p>
<p>Thanks to the JNIEnv proxy on <code>GetMethodID</code> and <code>CallVoidMethodV</code>,
PGSharp is able to monitor the calls to <code>SafetyNetService.attest(bytes[] nonce)</code>. When this function is called,
PGSharp intercepts the nonce and forward the request to its servers:</p>
<center>
<span class=red>https://tens.pgsharp.com/v1/scc-2-eg[...]4/</span><br><br>
</center>
<p>The request is performed through a http POST, whose the data are encrypted with AES. The clear payload
has the following layout:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=s2>&#34;Cy[...]&#34;</span><span class=p>,</span>
  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;attest&#34;</span><span class=p>,</span>
  <span class=nt>&#34;ver&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;PGSharp Version&gt;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=s2>&#34;i3[...]&#34;</span><span class=p>,</span>
  <span class=nt>&#34;clt&#34;</span><span class=p>:</span> <span class=s2>&#34;pgs&#34;</span><span class=p>,</span>
  <span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;k&#34;</span><span class=p>:</span> <span class=s2>&#34;AIzaSyCh8l[...]_eOTXhM4 &lt;- From nativeGetApiKey&#34;</span><span class=p>,</span>
    <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;nonce&gt;&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>On success, the server responses with an AES-encrypted payload which has the following layout:</p>
<pre tabindex=0><code>{&quot;result&quot;:&quot;suc: &lt;JWT SafetyNet Attestation&gt;&quot;}
</code></pre><p>The JWT SafetyNet value is then forwarded by PGSharp to <code>nativeAttestResponse()</code> with the original nonce.
At some point, this JWT attestation is sent to Niantic&rsquo;s servers (on the endpoint <code>plfe/112/rpc2</code>)
wrapped by a Protobuf structure.</p>
<p>To understand how they <em>&ldquo;bypass&rdquo;</em> SafetyNet, let&rsquo;s look at the JWT payload:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;nonce&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;nonce&gt;&#34;</span><span class=p>,</span>
  <span class=nt>&#34;timestampMs&#34;</span><span class=p>:</span> <span class=mi>1636265656</span><span class=p>,</span>
  <span class=nt>&#34;apkPackageName&#34;</span><span class=p>:</span> <span class=s2>&#34;com.nianticlabs.pokemongo&#34;</span><span class=p>,</span>
  <span class=nt>&#34;apkDigestSha256&#34;</span><span class=p>:</span> <span class=s2>&#34;ioYmlh5mk5EhMUH/DsaG1jrhUoQJDK/2IvK61eiAXJE=&#34;</span><span class=p>,</span>
  <span class=nt>&#34;ctsProfileMatch&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=nt>&#34;apkCertificateDigestSha256&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;lEvaRm6vZL4ck4ltXI6aRUoHyNj8vEre7vs1RbM16Xk=&#34;</span>
  <span class=p>],</span>
  <span class=nt>&#34;basicIntegrity&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=nt>&#34;evaluationType&#34;</span><span class=p>:</span> <span class=s2>&#34;BASIC&#34;</span>
<span class=p>}</span>
</code></pre></div><p>First of all, the JWT is correctly signed by Google SafetyNet&rsquo;s key and the <code>apkCertificateDigestSha256</code>
matches the signature of the real PokemonGO application.</p>
<p>But &mldr;</p>
<p>The value of <code>apkDigestSha256</code> does not match the checksum of the genuine PokemonGO application 😕</p>
<p><strong>Here are my hypothesis:</strong></p>
<p>The server <code>https://tens.pgsharp.com/v1/scc-2-eg/...</code> forwards the SafetyNet request to
a real application that runs on a real device. This application would have been created by PGSharp authors
to <em>really</em> run SafetyNet and to get a valid attestation signed with a valid Google key.
The fake application would have been created with <code>com.nianticlabs.pokemongo</code> as package name
and would implement signature mocking, as discussed in the first part.</p>
<p>If they would have managed to break SafetyNet, the <code>apkDigestSha256</code> value would have been consistent.</p>
<p>The JWT attestation is forwarded to Niantic so they might check the consistency of <code>apkDigestSha256</code>
but they might only focus on the signature (which can be faked) and not this value &mldr;</p>
<h3 id=pgsharp-signature-check>
<a href=#toc><i class="fas fa-angle-up"></i>  When PGSharp avoids PokemonGO pitfalls</a></h3>
<p>As discussed in the section
<a href=#signature-bypass><em>Signature Bypass</em></a>, PGSharp
tricks the Android PackageManager to mock the signature of the application.</p>
<p>It turns out that PGSharp is also concerned about app repackaging. As they provide premium
features, they don&rsquo;t want to be cheated &mldr;</p>
<p>In the function associated with <code>PGS_ACTIONS.INITPOST</code> they perform a device fingerprint
whose one of these elements is the APK&rsquo;s signature. But instead of using the Android PackageManager to
retrieve the signature, they use
<a href=https://github.com/DimaKoz/stunning-signature target=_blank rel=noopener>DimaKoz/stunning-signature</a>
to compute the MD5 digest of the signature.</p>
<h2 id=final-words>
<a href=#toc><i class="fas fa-angle-up"></i>  Final Words</a></h2>
<p>When I started to look at this cheating app, I did not expect to find such nice tricks and challenges.
The PGSharp&rsquo;s authors know the sneaky tricks to hinder reverse engineering. Unfortunately,
O-LLVM is relatively weak in this context compared to the commercial obfuscator used by Niantic.</p>
<p>On the other hand, the design of PokemonGO is such that all the reverse engineering difficulties
lie in one single module that can be treated in black-box once we identified the API. In particular, the
un-obfuscated Java layer helps a lot to identify these API.</p>
<p>Regarding the signature bypass, at first, I thought it would be easy to prevent by checking the integrity
of the <code>.apk</code> and/or the native libraries. But, there are some points that need to be taken into account:</p>
<p><strong>APK Integrity Check</strong></p>
<p>Naively, we might want to compute a checksum of the APK or re-compute the signature (as it&rsquo;s done by PGSharp).
But in fact, since a few years, Google tries to push
developers to use app bundle such as an application is no longer a single <code>.apk</code> but a split <code>.apk</code>.
While this feature optimizes the device&rsquo;s data partition size, it complicates the verification
of the signature since it would require to deal with different files and different checksum.</p>
<p>It&rsquo;s not infeasible, but it complicates its implementation in the APK build & development pipeline.</p>
<p><strong>Native Library Integrity Check</strong></p>
<p>I guess that <code>libNianticLabsPlugin.so</code> implements checksum on its own library as it is
a sensitive part of the application. Regarding the other libraries, some of them are owned
by Niantic (like <code>libholoholo.so</code>) and others come from third-parties (like <code>libmain.so</code>). Depending on
how they are integrated, the checksum of these external libraries might not be easy to automatically
compute while releasing a new version of PokemonGO. These third-party libraries are,
most of the time, not copy-pasted by the developers but automatically bundled when compiling the
application. Therefore, computing their checksums might require tweaking the build process
in a non-easy way.</p>
<p>On the top of that, Niantic releases a new version of its games on a monthly basis. It means
that these checks need to be automated in CI/CD pipeline which might not be trivial to do.</p>
<hr width=50%>
<p>It was a funny and very interesting journey, for those who want to dig a bit more
in PGSharp, I pushed some materials and documents on Github. In particular, you can
find the symbol list of <b class=red>libmain.so</b> based on reverse engineering.</p>
<center>
<i class="fas fa-github"></i>&nbsp;&nbsp;&nbsp;<a href=https://github.com/romainthomas/pgsharp target=_blank rel=noopener>https://github.com/romainthomas/pgsharp</a>
</center>
<h2 id=acknowledgments>
<a href=#toc><i class="fas fa-angle-up"></i>  Acknowledgments</a></h2>
<p>This analysis has been independently done in my spare time while being at
<a href=https://www.quarkslab.com target=_blank rel=noopener>Quarkslab</a> and
<a href=https://www.ul.com target=_blank rel=noopener class=ul>Underwriters Laboratories</a>,
my current employer.</p>
<h2 id=annexes>
<a href=#toc><i class="fas fa-angle-up"></i>  Annexes</a></h2>
<h3 id=third-party>Third-Party</h3>
<p>Here is the (non exhaustive) list of the open-source projects used by PGSharp:</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>
<a href=https://github.com/jmpews/Dobby target=_blank rel=noopener>https://github.com/jmpews/Dobby</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/or-dvir/EasySettings target=_blank rel=noopener>https://github.com/or-dvir/EasySettings</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/zupet/LuaTinker target=_blank rel=noopener>https://github.com/zupet/LuaTinker</a> or
<a href=https://github.com/yanwei1983/luatinkerE target=_blank rel=noopener>https://github.com/yanwei1983/luatinkerE</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/DimaKoz/stunning-signature target=_blank rel=noopener>https://github.com/DimaKoz/stunning-signature</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://www.sqlite.org/index.html target=_blank rel=noopener>https://www.sqlite.org/index.html</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/nlohmann/json target=_blank rel=noopener>https://github.com/nlohmann/json</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://www.lua.org/manual/5.3/ target=_blank rel=noopener>https://www.lua.org/manual/5.3/</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/kikito/md5.lua target=_blank rel=noopener>https://github.com/kikito/md5.lua</a></td>
</tr>
<tr>
<td style=text-align:left>
<a href=https://github.com/rxi/json.lua target=_blank rel=noopener>https://github.com/rxi/json.lua</a></td>
</tr>
</tbody>
</table>
<h3 id=list-of-the-unity-functions-used-by-pgsharp>List of the Unity Functions used by PGSharp</h3>
<div class=spoiler>
<p>
<a class="btn btn-primary" data-toggle=collapse href=#spoiler-15 role=button aria-expanded=false aria-controls=spoiler-15>
<i class="fas fa-table"></i>&nbsp;&nbsp;Expand
</a>
</p>
<div class="collapse card" id=spoiler-15>
<div class=card-body>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>object__Invoke
String_CreateString1
String_CreateString3
ulong_object___get_Item
ulong_object___ContainsKey
ulong_object___TryGetValue
Application_OpenURL
Application_set_targetFrameRate
Quaternion_Angle
PlayerPrefs_TrySetInt
PlayerPrefs_TrySetFloat
PlayerPrefs_TrySetSetString
PlayerPrefs_SetInt
PlayerPrefs_GetInt
PlayerPrefs_SetFloat
PlayerPrefs_GetFloat
PlayerPrefs_SetString
PlayerPrefs_GetStringNoDefault
PlayerPrefs_HasKey
PlayerPrefs_DeleteKey
Component_get_gameObject
Transform_get_rotation
Animator_get_speed
Animator_set_speed
Animator_SetTriggerID
Animator_Update
Promise__ctor
Promise_Complete
MapMath_MetersBetween
NL_NLAny_object_
NL_NLFirst_object_
InputField_ActivateInputField
InputField_DeactivateInputField
Text_set_text
Text_set_fontSize
DiContainer_InjectExplicitInternal
Schedule_WaitOn_c__AnonStorey0____m__0
GameState_EnterState
GameState_ExitState
RpcBindings_Send
RpcManager_DispatchCallbacks
Animator_SetTriggerID
RpcManager_DispatchCallbacks
AuthService_get_CachedCredentialsExist
AuthService_Logout
DeviceServiceExtensions_IsUsable
GameMasterData_IsPokemonWeatherBoosted
Animator_SetTriggerID
AuthService_get_CachedCredentialsExist
AuthService_Logout
PgpApi_UpdateNotifications
ARPlusEncounterValuesProto__ctor
ARPlusEncounterValuesProto__cctor
PlayerService_GetPlayerDayBucket
PlayerService_get_PlayerStats
PlayerService_get_CurrentPokeball
PlayerService_get_CurrentLinkedLogins
AuthService_get_CachedCredentialsExist
PlayerService_get_PokemonBag
PlayerService_GetPlayerProfile
PlayerService_set_CurrentPokeball
PlayerService_get_BagIsFull
PlayerService_GetCandyCountForPokemon
StateToken_Complete
TimeUtil_ServerNowMs
RequestGymDetailsById_onSucceed
RequestGymDetailsById_onError
PlayerPrefs_SetInt
BluetoothUtil_get_IsBluetoothEnabled
PgpGuiController_ClickIcon
PgpGuiService_SetSfidaIconVisible
PgpGuiService_EnableSfidaIcon
ulong_object___get_Item
PgpService_get_IsSessionActive
PgpService_GetCurrentNotificationType
ItemBagImpl_GetItemCount
PokemonBagImpl_GetPokemon
ulong_object___get_Item
PgpApi_UpdateNotifications
Animator_set_speed
StateToken_Complete
VersionCheckService_CheckVersion
ulong_object___TryGetValue
QuestMapPokemon_get_Pokemon
QuestService_BeginQuestEncounterWithOut
EulaGuiController_PressAccept
StarterMapPokemon_get_Pokemon
OpenRemoteGym_gymOpner
OpenRemoteGym_onSucceed
BluetoothUtil_get_IsBluetoothEnabled
QuestService_BeginQuestEncounterWithOut
RaidState_ExitGymWithRaidDetails
AccountChoiceState_ClickNewPlayer
AccountChoiceState_ClickExistingPlayer
LoginAgeGateState_SubmitSelections
LoginChoiceState_ClickPtc
LoginChoiceState_ClickGoogle
LoginGuiController_ClickSubmit
PtcLoginState_SubmitLogin
I18n_PokemonMoveName
I18n_SetUpLanguageTable
I18n_PokemonNameTemporaryEvolution
I18n_Text
I18n_PokemonName
FriendsGuiState_StartOpenGiftFlow
FriendsGuiState_StartSendGiftFlow
FriendsRpcService_RemoveGiftbox
GiftingRpcService_SendGift
GiftingRpcService_OpenGift
StickerService_GetStickerInventory
CombatDirector_Initialize
MapPokestop_get_PoiId
MapPokestop_get_ActiveIncidentType
MapPokestop_get_Location
EncounterParkCameraController_PlayIntro
RunPokemonCaptured_onDitto
EncounterInteractionState_RunAway
MapMath_MetersBetween
PlayerPrefs_TrySetSetString
EncounterInteractionState_IntroCompleted
AttemptCapture_onResponse
EncounterIntroState_ExitState
EncounterPokemon_get_MapPokemon
PlayerPrefs_HasKey
ItemBagImpl_GetItemCount
Pokeball_TryHitPokemon
Pokeball_FlyStateImpl_Capture__MoveNext
Pokeball_DropStateImpl_Capture__MoveNext
EncounterGuiController_ShowPokemonFlee
EncounterState_get_EncounterType
EncounterState_EncounterStateComplete
EncounterState_EncounterStateComplete
EncounterState_get_MapPokemon
EncounterState_OnEncounterResponse
DefaultEncounter_get_DefaultBall
ExtraMapPokemon_get_Pokemon
ResearchEncounter_get_DefaultBall
ResearchEncounter_get_DefaultBall
object_object__object___CurrentPageIndex
PokemonInventoryCellView_Initialize
ToastService_OneLineMedium
ToastService_RewardItemNameAmount
ToastService_RewardItemDefault
ToastService_RewardItemStardust
ToastService_OneLineMediumWithParams
ToastService_RewardItemXlCandy
ToastService_RewardItemAmount
ToastService_TwoLine
ToastService_RewardItemAmountType
ToastService_RewardItemMegaResource
ToastService_RewardSticker
ToastService_OneLineWithParams
ToastService_OneLineBig
ToastService_OneLineBigWithParams
ToastService_RewardItemCandy
UserPromptsService_HasActiveModal
UserPromptsService_DismissActiveModal
PokemonInfoDynoScrollRect_Cleanup
Quaternion_Angle
Animator_get_speed
PokemonInfoPanel_DoUpdate
GymRootController_get_View
GymRootController_get_MapGym
MapGym_get_PoiId
MapGym_OnTap
MapGym_get_Location
RaidMapPokemon_get_Pokemon
MapContentHandler_UpdateCells
MapEntityCell_get_Pois
MapEntityService_get_Cells
MapEntityService_GetMapPoi
MapEntityService_UpdatePois
MapExploreState_GymSelected
MapExploreState_EnterQuestEncounter
MapPokemon_get_Location
MapPokemon_get_DespawnTime
MapPokemon_TryCapture
PhotobombingMapPokemon_get_Pokemon
MapPokestop_get_ActiveIncidentType
SendEncounterRequestCapture_onResponse
PoiMapPokemon_get_SpawnPointId
PoiMapPokemon_get_EncounterId
WildMapPokemon_get_Pokemon
WildMapPokemon_SendEncounterRequest
PoiDirectoryService_AddPokemon
PoiDirectoryService_RemovePokemon
RaidMapPokemon_get_Pokemon
IncidentMapPokemon_get_Pokemon
IncenseMapPokemon_SendEncounterRequest
IncenseMapPokemon_OnDestroy
IncenseMapPokemon_get_Pokemon
TroyDiskMapPokemon_SendEncounterRequest
TroyDiskMapPokemon_get_Pokemon
GroundTapHandler_OnTap
GroundTapHandler_OnTap1
MapViewHandler_GetGroundLocation
MapViewHandler_GetGroundPosition
MapViewHandler_GetWorldLocation
NL_NLFirst_object_
CompassGuiController_Update
PlayerService_SetPlayerProto
MapPokemon_LogEncounterMetrics
</code></pre></div>
</div>
</div>
</div>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>O-LLVM provides control-flow obfuscation that can be <em>recovered</em> with emulation.
On the other hand, the data-flow (function parameters, stack values, memory accesses) can be analysed at a basic-block level with static analysis.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p><b class=red>libmain.so</b> is also <strong>statically</strong> linked against other libraries like
<a href=https://github.com/jmpews/Dobby target=_blank rel=noopener>jmpews/Dobby</a>,
<a href=https://github.com/nlohmann/json target=_blank rel=noopener>nlohmann/json</a>,
<a href=https://github.com/sqlite/sqlite target=_blank rel=noopener>sqlite</a> &mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p>Modded apps use similar tricks as discussed in
<a href=https://blog.quarkslab.com/android-application-diffing-analysis-of-modded-version.html#defeating-obfuscation target=_blank rel=noopener>Android Application Diffing: Analysis of Modded Version</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p>In order to arbitrarily call the underlying function when needed.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:5 role=doc-endnote>
<p>The package names are stripped with Proguard but we can quite easily recover those packages.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:6 role=doc-endnote>
<p>Basically, they renamed
<a href=https://github.com/jmpews/Dobby/blob/bba23cbee8e3cfff5622ef8b63fb797703baea5f/include/dobby.h#L157 target=_blank rel=noopener>DobbyHook</a> in <code>FbbUePBslRNHWkdS</code>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:7 role=doc-endnote>
<p>The event is triggered when <code>nativeMuteMasterAudio</code> or <code>nativeRender</code> is registered and they
get the base address by iterating over <code>/proc/&lt;pid>/maps</code>.&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:8 role=doc-endnote>
<p>O-LLVM seems not applied on this function&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:9 role=doc-endnote>
<p>One can also hook the AES encrypt/decrypt functions whose the prototype is <code>(uint8_*t key_schedule, uint8_t* inout_buffer, size_t size)</code>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<div class=article-tags>
<a class="badge badge-light" href=/tags/android/>android</a>
<a class="badge badge-light" href=/tags/reverse-engineering/>reverse engineering</a>
<a class="badge badge-light" href=/tags/obfuscation/>obfuscation</a>
</div>
</div>
</article>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js integrity="sha512-7t8APmYpzEsZP7CYoA7RfMPV9Bb+PJHa9x2WiUnDXZx3XHveuyWUtvNOexhkierl5flZ3tr92dP1mMS+SGlD+A==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/armasm.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script>
<script>const code_highlighting=!0</script>
<script>const isSiteThemeDark=!1</script>
<script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script>
<script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script>
<script src=/js/academic.min.f6ecf7692215f2bc4850b72c8176bfa2.js></script>
<div class=container>
<footer class=site-footer>
<p class=powered-by>
Published with <a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic Website Builder</a>
</p>
<p class=powered-by>
<span class=float-right aria-hidden=true>
<a href=# class=back-to-top>
<span class=button_icon>
<i class="fas fa-chevron-up fa-2x"></i>
</span>
</a>
</span>
</p>
</footer>
</div>
<div id=modal class="modal fade" role=dialog>
<div class=modal-dialog>
<div class=modal-content>
<div class=modal-header>
<h5 class=modal-title>Cite</h5>
<button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span>
</button>
</div>
<div class=modal-body>
<pre><code class="tex hljs"></code></pre>
</div>
<div class=modal-footer>
<a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank>
<i class="fas fa-copy"></i> Copy
</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank>
<i class="fas fa-download"></i> Download
</a>
<div id=modal-error></div>
</div>
</div>
</div>
</div>
</body>
</html>